import{c as Ue,bv as Ge,J as Re,K as Ze,a8 as We,u as Ye,ak as Ke,r,k as b,M as we,Y as Me,L as je,bF as l,j as qe,w as u,o as Je,bG as v,ae as Qe,bH as Xe,aI as et,bI as tt,bJ as ot,bK as Te,aF as at,bL as nt,bM as P,y as it,bd as lt,l as T,m as Q,G as st,v as rt,q as s,n as ct,H as x,N as C,I as N,a6 as F,a0 as U,au as O,s as H,a1 as G,bN as ut,V as dt,O as X,P as vt,Q as mt,R as pt,a5 as ft,W as gt,bO as ht,F as yt,bP as bt,bQ as xt,bR as kt,z as wt,B as Mt,E as Tt,_ as Ct}from"./index-Bfn_MSyI.js";const Vt=["id"],Et=Ue({__name:"Map",props:{widget:{}},setup(Ce){var ke;Ge(e=>({"9cb03a6a":_e.value}));const ee=Ce,h=Re(ee).widget,Ve=Ze(),{showDialog:Ee}=We(),n=Ye(),w=Ke(),o=r(),A=r(w.defaultMapZoom),L=r(w.defaultMapCenter),f=r(),te=b(()=>`map-${h.value.hash}`),V=r(!1),oe=r(!1),R=r([]),ae=r(),Z=r(!1);let ne;const ie=e=>{e.touches.length>1&&(Z.value=!0,k.value&&$(),clearTimeout(ne))},le=e=>{e.touches.length<=1&&(ne=window.setTimeout(()=>Z.value=!1,300))};we.registerUsage(Me.latitude),we.registerUsage(Me.longitude),je(()=>{Object.keys(h.value.options).length===0&&(h.value.options={showVehiclePath:!0}),m.enableAutoUpdate()});const se=l.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:23,maxNativeZoom:19,attribution:"Â© OpenStreetMap"}),re=l.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{maxZoom:23,maxNativeZoom:19,attribution:"Â© Esri World Imagery"}),ce=l.tileLayer("https://tiles.openseamap.org/seamark/{z}/{x}/{y}.png",{maxZoom:18,attribution:"Â© OpenSeaMap contributors"}),ue=l.tileLayer.wms("https://geoserver.openseamap.org/geoserver/gwc/service/wms",{layers:"gebco2021:gebco_2021",format:"image/png",transparent:!0,version:"1.1.1",attribution:"Â© GEBCO, OpenSeaMap",tileSize:256,maxZoom:19}),Le={OpenStreetMap:se,"Esri World Imagery":re},Se={Seamarks:ce,"Marine Profile":ue},S=r(),de=qe(S),ve=l.control.zoom({position:"bottomright"}),me=l.control.layers(Le,Se);u(V,()=>{o.value!==void 0&&(V.value?(o.value.addControl(ve),o.value.addControl(me)):(o.value.removeControl(ve),o.value.removeControl(me)))}),u(de,()=>{V.value=de.value}),Je(async()=>{var e,t;h.value.options.blockGenericContextMenu=!0,(e=S.value)==null||e.addEventListener("touchstart",ie,{passive:!0}),(t=S.value)==null||t.addEventListener("touchend",le,{passive:!0}),o.value=l.map(te.value,{layers:[se,re,ce,ue],attributionControl:!1}).setView(L.value,A.value),o.value.removeControl(o.value.zoomControl),o.value.on("click",a=>{y.value=[a.latlng.lat,a.latlng.lng]}),o.value.on("moveend",()=>{if(o.value===void 0)return;let{lat:a,lng:i}=o.value.getCenter();a&&i&&(L.value=[a,i])}),o.value.on("zoomend",()=>{var a;k.value=!1,o.value!==void 0&&(A.value=((a=o.value)==null?void 0:a.getZoom())??L.value)}),o.value.on("contextmenu",a=>{y.value=[a.latlng.lat,a.latlng.lng]}),m.enableAutoUpdate(),window.addEventListener("keydown",he),p.value?m.goToTarget(v.VEHICLE):m.goToTarget(v.HOME),!n.isVehicleOnline&&w.vehicleMission.length&&q(w.vehicleMission),oe.value=!0,await W()});const Ie={open:e=>{o.value&&(Z.value||(e.preventDefault(),e.stopPropagation(),ae.value.openAt(e),k.value=!0))},close:()=>{$()}},Oe=()=>{var e;(e=o.value)==null||e.eachLayer(t=>{(t instanceof l.Marker||t instanceof l.Polyline&&t.options.color==="#358AC3")&&o.value.removeLayer(t)}),R.value=[],_.value=void 0,E.value=void 0,g.value=void 0},W=async()=>{oe.value&&(Oe(),n.isVehicleOnline?await be():w.vehicleMission.length&&q(w.vehicleMission))};u(()=>n.isVehicleOnline,()=>{W()}),u(()=>w.vehicleMissionRevision,()=>{W()}),Qe(()=>{var e,t;m.disableAutoUpdate(),window.removeEventListener("keydown",he),(e=S.value)==null||e.removeEventListener("touchstart",ie),(t=S.value)==null||t.removeEventListener("touchend",le)}),u(L,(e,t)=>{var a;e.toString()!==t.toString()&&((a=o.value)==null||a.panTo(e))}),u(o,(e,t)=>{o.value!==void 0&&(e==null?void 0:e.options)===void 0&&(o.value=t)}),u(A,(e,t)=>{var a;e!==t&&(k.value=!1,(a=o.value)==null||a.setZoom(A.value))}),u(ee.widget,()=>{var e;(e=o.value)==null||e.invalidateSize()});const I=r(void 0),m=new Xe(e=>I.value=e,e=>L.value=e);m.setTrackableTarget(v.VEHICLE,()=>p.value),m.setTrackableTarget(v.HOME,()=>f.value);const p=b(()=>n.coordinates.latitude?[n.coordinates.latitude,n.coordinates.longitude]:void 0),Y=b(()=>{var e;return n.attitude.yaw?et((e=n.attitude)==null?void 0:e.yaw):0}),pe=b(()=>{const e=n.lastHeartbeat;return e?`${tt(e??0,{includeSeconds:!0})} ago`:"never"}),{history:He}=ot(p);(ke=navigator==null?void 0:navigator.geolocation)==null||ke.watchPosition(e=>{f.value||(f.value=[e.coords.latitude,e.coords.longitude])},e=>console.error(`Failed to get position: (${e.code}) ${e.message}`),{enableHighAccuracy:!1,timeout:5e3,maximumAge:0});let fe=!0;u([f,o],async()=>{f.value===L.value||!o.value||!fe||(m.goToTarget(v.HOME),fe=!1)});const M=r();u(n.coordinates,()=>{if(!(!o.value||!p.value)){if(M.value===void 0){let e=bt;n.vehicleType===Te.MAV_TYPE_SURFACE_BOAT?e=xt:n.vehicleType===Te.MAV_TYPE_SUBMARINE&&(e=kt);const t=l.divIcon({className:"vehicle-marker",html:`<img src="${e}" style="width: 64px; height: 64px;">`,iconSize:[64,64],iconAnchor:[32,32]});M.value=l.marker(p.value,{icon:t});const a=l.tooltip({content:"No data available",className:"waypoint-tooltip",offset:[40,0]});M.value.bindTooltip(a),o.value.addLayer(M.value)}M.value.setLatLng(p.value)}}),u(p,(e,t)=>{I.value===v.VEHICLE||t!==void 0||m.follow(v.VEHICLE)}),u([p,Y,pe,()=>n.isArmed],()=>{var t,a,i,c,d;if(M.value===void 0)return;(c=M.value.getTooltip())==null||c.setContent(`
    <p>Coordinates: ${(t=p.value)==null?void 0:t[0].toFixed(6)}, ${(a=p.value)==null?void 0:a[1].toFixed(6)}</p>
    <p>Velocity: ${((i=n.velocity.ground)==null?void 0:i.toFixed(2))??"N/A"} m/s</p>
    <p>Heading: ${Y.value.toFixed(2)}Â°</p>
    <p>${n.isArmed?"Armed":"Disarmed"}</p>
    <p>Last seen: ${pe.value}</p>
  `);const e=(d=M.value.getElement())==null?void 0:d.querySelector("img");e&&(e.style.transform=`rotate(${Y.value}deg)`)});const E=r();u(f,()=>{if(o.value===void 0)return;const e=f.value;if(e!==void 0)if(E.value)E.value.setLatLng(e);else{E.value=l.marker(e,{icon:l.divIcon({className:"marker-icon",iconSize:[24,24],iconAnchor:[12,12]}),draggable:!0});const t=l.tooltip({content:'<i class="mdi mdi-home-map-marker text-[18px] border-[2px] rounded-full"></i>',permanent:!0,direction:"center",className:"waypoint-tooltip",opacity:1});E.value.bindTooltip(t),E.value.on("dragend",a=>{const c=a.target.getLatLng();J([c.lat,c.lng])}),o.value.addLayer(E.value)}});const _=r();u(R,e=>{o.value&&(_.value||(_.value=l.polyline([],{color:"#358AC3"}).addTo(o.value)),_.value.setLatLngs(e.map(t=>t.coordinates)),e.forEach((t,a)=>{var d;const i=l.marker(t.coordinates);i.setIcon(l.divIcon({className:"marker-icon",iconSize:[16,16],iconAnchor:[8,8]}));const c=l.tooltip({content:a.toString(),permanent:!0,direction:"center",className:"waypoint-tooltip",opacity:1});i.bindTooltip(c),(d=o.value)==null||d.addLayer(i)}))},{deep:!0});const K=r();u(He,e=>{if(o.value===void 0||e===void 0)return;K.value===void 0&&(K.value=l.polyline([],{color:"#ffff00"}).addTo(o.value));const t=e.filter(a=>a.snapshot!==void 0).map(a=>a.snapshot);K.value.setLatLngs(t)});const k=r(!1),y=r(null),ge=r(),Ae=at([{item:"Set home waypoint",action:()=>j("set-home-waypoint"),icon:"mdi-home-map-marker"},{item:"GoTo",action:()=>j("goto"),icon:"mdi-send-variant"},{item:"Set default map position",action:()=>j("set-default-map-position"),icon:"mdi-map-check"}]),g=r();let B=!1;const ze=async()=>{var e;if(!(!o.value||!y.value))try{await w.setDefaultMapPosition(y.value,A.value),P({message:"Default map position set",variant:"success"});const t=l.marker(y.value,{icon:l.divIcon({className:"marker-icon",iconSize:[24,24],iconAnchor:[12,12]})}).addTo(o.value),a=l.tooltip({content:'<i class="mdi mdi-map-check text-[16px] border-[2px] rounded-full p-[2px]"></i>',permanent:!0,direction:"center",className:"waypoint-tooltip",opacity:1});t.bindTooltip(a).openTooltip();const i=t.getElement(),c=(e=t.getTooltip())==null?void 0:e.getElement();[i,c].forEach(d=>{d&&(d.style.transition="opacity 1s",d.style.opacity="1")}),setTimeout(()=>{[i,c].forEach(d=>{d&&(d.style.opacity="0")}),setTimeout(()=>{var d;(d=o.value)==null||d.removeLayer(t)},1e3)},1500)}catch(t){console.error(t),P({message:"Failed to set default map position",variant:"error"})}},Pe=()=>{if(!y.value||!o.value)return;g.value&&(o.value.removeLayer(g.value),g.value=void 0),g.value=l.marker(y.value,{icon:l.divIcon({className:"marker-icon",iconSize:[24,24],iconAnchor:[12,12]})}).addTo(o.value);const e=l.tooltip({content:'<i class="mdi mdi-send-circle-outline text-[28px]"></i>',permanent:!0,direction:"center",className:"waypoint-tooltip",opacity:1});g.value.bindTooltip(e),B=!1,Promise.resolve(wt(async()=>{B=!0;const[t,a]=y.value,i=n.coordinates.altitude??0;try{await n.goTo(0,0,0,0,t,a,i)}catch(c){P({message:`${c}`,variant:"error"})}},{command:"GoTo"},Mt(Tt.GOTO))).catch(()=>{g.value&&o.value&&(o.value.removeLayer(g.value),g.value=void 0)})},j=e=>{switch(console.log("ðŸš€ ~ option:",e),e){case"goto":{Pe();break}case"set-default-map-position":ze();break;case"set-home-waypoint":y.value&&J(y.value);break;default:console.warn("Unknown menu option selected:",e)}k.value=!1};u(nt,(e,t)=>{t&&!e&&(!B&&g.value&&o.value&&(o.value.removeLayer(g.value),g.value=void 0),B=!1)});const $=()=>{k.value=!1,o.value!==void 0&&ge.value!==void 0&&o.value.removeLayer(ge.value)},he=e=>{e.key==="Escape"&&$()},q=e=>{e.forEach((t,a)=>{a===0?(f.value=t.coordinates,J(t.coordinates)):R.value.push(t)})},D=r(!1),ye=r(0),be=async()=>{D.value=!0;const e=async t=>{ye.value=t};try{const t=await n.fetchMission(e);q(t),P({variant:"success",message:"Mission download succeeded!",duration:3e3})}catch(t){Ee({variant:"error",title:"Mission download failed",message:t,timer:5e3})}finally{D.value=!1}},J=async e=>{const t=[e[0],e[1]];f.value=t,await n.setHomeWaypoint(t,0),k.value&&(k.value=!1)},Ne=async()=>{try{await n.startMission()}catch{P({message:"Failed to start mission.",variant:"error"})}},z=it(),_e=b(()=>`${Math.max(-z.widgetClearanceForVisibleArea(h.value).bottom,0)}px`),xe=b(()=>`${Math.max(-z.widgetClearanceForVisibleArea(h.value).top,0)}px`),Be=b(()=>n.isVehicleOnline?"Download the mission that is stored in the vehicle.":"Cannot download mission (vehicle offline)."),$e=b(()=>n.isVehicleOnline?"Execute the mission that is stored in the vehicle.":"Cannot execute mission (vehicle offline)."),De=b(()=>f.value===void 0?"Cannot center map on home (home position undefined).":I.value===v.HOME?"Tracking home position. Click to stop tracking.":"Click once to center on home or twice to track it."),Fe=b(()=>n.isVehicleOnline?p.value===void 0?"Cannot center map on vehicle (vehicle position undefined).":I.value===v.VEHICLE?"Tracking vehicle position. Click to stop tracking.":"Click once to center on vehicle or twice to track it.":"Cannot center map on vehicle (vehicle offline).");return(e,t)=>{const a=lt("contextmenu");return T(),Q(yt,null,[st((T(),Q("div",{ref_key:"mapBase",ref:S,class:rt(["page-base",s(z).editingMode?"pointer-events-none":"pointer-events-auto"])},[ct("div",{id:te.value,ref_key:"map",ref:o,class:"map"},[x(G,{location:"top",text:De.value},{activator:C(({props:i})=>[V.value?(T(),N(F,U({key:0},i,{class:["absolute right-[166px] m-3 bottom-button bg-slate-50 text-[14px]",f.value?"":"active-events-on-disabled"],color:I.value==s(v).HOME?"red":"",elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-home-search",size:"x-small",disabled:!f.value,onClick:t[0]||(t[0]=O(c=>s(m).goToTarget(s(v).HOME,!0),["stop"])),onDblclick:t[1]||(t[1]=O(c=>s(m).follow(s(v).HOME),["stop"]))}),null,16,["class","color","disabled"])):H("",!0)]),_:1},8,["text"]),x(G,{location:"top",text:Fe.value},{activator:C(({props:i})=>[V.value?(T(),N(F,U({key:0},i,{class:["absolute m-3 bottom-button right-[124px] bg-slate-50 text-[14px]",p.value?"":"active-events-on-disabled"],color:I.value==s(v).VEHICLE?"red":"",elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-airplane-marker",size:"x-small",disabled:!p.value,onClick:t[2]||(t[2]=O(c=>s(m).goToTarget(s(v).VEHICLE,!0),["stop"])),onDblclick:t[3]||(t[3]=O(c=>s(m).follow(s(v).VEHICLE),["stop"]))}),null,16,["class","color","disabled"])):H("",!0)]),_:1},8,["text"]),x(G,{location:"top",text:Be.value},{activator:C(({props:i})=>[V.value?(T(),N(F,U({key:0},i,{class:["absolute m-3 bottom-button right-[82px] bg-slate-50 text-[14px]",s(n).isVehicleOnline?"":"active-events-on-disabled"],disabled:!s(n).isVehicleOnline,elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-download",size:"x-small",onClick:O(be,["stop"])}),null,16,["class","disabled"])):H("",!0)]),_:1},8,["text"]),x(G,{location:"top",text:$e.value},{activator:C(({props:i})=>[V.value?(T(),N(F,U({key:0},i,{class:["absolute mb-3 ml-1 bottom-button right-[52px] bg-slate-50 text-[14px]",s(n).isVehicleOnline?"":"active-events-on-disabled"],disabled:!s(n).isVehicleOnline,elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-play",size:"x-small",onClick:O(Ne,["stop"])}),null,16,["class","disabled"])):H("",!0)]),_:1},8,["text"])],8,Vt)],2)),[[a,Ie]]),x(ut,{ref_key:"contextMenuRef",ref:ae,visible:k.value,width:"260px","menu-items":Ae,onClose:$},null,8,["visible","menu-items"]),x(gt,{modelValue:s(z).widgetManagerVars(s(h).hash).configMenuOpen,"onUpdate:modelValue":t[5]||(t[5]=i=>s(z).widgetManagerVars(s(h).hash).configMenuOpen=i),width:"auto"},{default:C(()=>[x(dt,{class:"pa-2",style:X(s(Ve).globalGlassMenuStyles)},{default:C(()=>[x(vt,{class:"text-center"},{default:C(()=>t[6]||(t[6]=[mt("Map widget settings")])),_:1}),x(pt,null,{default:C(()=>[x(ft,{modelValue:s(h).options.showVehiclePath,"onUpdate:modelValue":t[4]||(t[4]=i=>s(h).options.showVehiclePath=i),class:"my-1",label:"Show vehicle path",color:s(h).options.showVehiclePath?"white":void 0,"hide-details":""},null,8,["modelValue","color"])]),_:1})]),_:1},8,["style"])]),_:1},8,["modelValue"]),D.value?(T(),N(ht,{key:0,"model-value":ye.value,height:"10",absolute:"",bottom:"",color:"white",style:X(`top: ${xe.value}`)},null,8,["model-value","style"])):H("",!0),D.value?(T(),Q("p",{key:1,style:X({top:xe.value}),class:"absolute left-[7px] mt-4 flex text-md font-bold text-white z-30 drop-shadow-md"}," Loading mission... ",4)):H("",!0)],64)}}}),St=Ct(Et,[["__scopeId","data-v-c7c1703d"]]);export{St as default};
