import{c as Qe,bv as Xe,J as et,K as tt,a8 as ot,u as at,ak as nt,r as l,k as w,M as Se,Y as $e,L as it,bF as i,j as st,w as d,o as lt,bG as v,ae as rt,bH as ct,aJ as ut,bI as dt,bJ as vt,bK as He,aG as mt,bL as O,bM as pt,y as ft,aN as gt,be as ht,l as E,m as ae,G as yt,v as bt,q as r,n as xt,H as x,N as L,I as F,a6 as G,a0 as Z,au as A,s as z,a1 as j,bN as kt,V as wt,O as ne,P as Mt,Q as Tt,R as Ct,a5 as Et,W as Lt,bO as Vt,bP as It,F as Ot,bQ as Pt,bR as St,bS as $t,B as Ht,C as At,E as zt,_ as Nt}from"./index-CmZ1z644.js";const _t=["id"],Ft=Qe({__name:"Map",props:{widget:{}},setup(Ae){var Oe;Xe(e=>({"69d1c8ff":Ze.value}));const ie=Ae,k=et(ie).widget,ze=tt(),{showDialog:Ne}=ot(),s=at(),g=nt(),o=l(),N=l(g.defaultMapZoom),P=l(g.defaultMapCenter),h=l(),se=w(()=>`map-${k.value.hash}`),V=l(!1),le=l(!1),Y=l([]),re=l(),J=l(!1),K=l(!1);let ce;const ue=e=>{e.touches.length>1&&(K.value=!0,M.value&&R(),clearTimeout(ce))},de=e=>{e.touches.length<=1&&(ce=window.setTimeout(()=>K.value=!1,300))},S=l(null),b=l({});Se.registerUsage($e.latitude),Se.registerUsage($e.longitude),it(()=>{Object.keys(k.value.options).length===0&&(k.value.options={showVehiclePath:!0}),p.enableAutoUpdate()});const ve=i.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:23,maxNativeZoom:19,attribution:"© OpenStreetMap"}),me=i.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{maxZoom:23,maxNativeZoom:19,attribution:"© Esri World Imagery"}),pe=i.tileLayer("https://tiles.openseamap.org/seamark/{z}/{x}/{y}.png",{maxZoom:18,attribution:"© OpenSeaMap contributors"}),fe=i.tileLayer.wms("https://geoserver.openseamap.org/geoserver/gwc/service/wms",{layers:"gebco2021:gebco_2021",format:"image/png",transparent:!0,version:"1.1.1",attribution:"© GEBCO, OpenSeaMap",tileSize:256,maxZoom:19}),_e={OpenStreetMap:ve,"Esri World Imagery":me},Fe={Seamarks:pe,"Marine Profile":fe},$=l(),ge=st($),he=i.control.zoom({position:"bottomright"}),ye=i.control.layers(_e,Fe);d(V,()=>{o.value!==void 0&&(V.value?(o.value.addControl(he),o.value.addControl(ye)):(o.value.removeControl(he),o.value.removeControl(ye)))}),d(ge,()=>{V.value=ge.value}),lt(async()=>{var e,t;(e=$.value)==null||e.addEventListener("touchstart",ue,{passive:!0}),(t=$.value)==null||t.addEventListener("touchend",de,{passive:!0}),o.value=i.map(se.value,{layers:[ve,me,pe,fe],attributionControl:!1}).setView(P.value,N.value),o.value.removeControl(o.value.zoomControl),o.value.on("click",a=>{m.value=[a.latlng.lat,a.latlng.lng]}),o.value.on("moveend",()=>{if(o.value===void 0)return;let{lat:a,lng:n}=o.value.getCenter();a&&n&&(P.value=[a,n])}),o.value.on("dragstart",()=>{J.value=!0}),o.value.on("dragend",()=>{setTimeout(()=>J.value=!1,200)}),o.value.on("zoomend",()=>{var a;M.value=!1,o.value!==void 0&&(N.value=((a=o.value)==null?void 0:a.getZoom())??P.value)}),o.value.on("contextmenu",a=>{m.value=[a.latlng.lat,a.latlng.lng]}),p.enableAutoUpdate(),window.addEventListener("keydown",Me),f.value?p.goToTarget(v.VEHICLE):p.goToTarget(v.HOME),!s.isVehicleOnline&&g.vehicleMission.length&&ee(g.vehicleMission),le.value=!0,await q()});const De={open:e=>{if(!o.value||K.value||J.value)return;e.preventDefault(),e.stopPropagation();const t=o.value.mouseEventToContainerPoint(e),a=o.value.containerPointToLatLng(t);m.value=[a.lat,a.lng],re.value.openAt(e),M.value=!0},close:()=>{R()}},be=()=>{var e;(e=o.value)==null||e.eachLayer(t=>{(t instanceof i.Marker||t instanceof i.Polyline&&t.options.color==="#358AC3")&&o.value.removeLayer(t)}),Y.value=[],D.value=void 0,I.value=void 0,y.value=void 0},q=async()=>{le.value&&(be(),s.isVehicleOnline?await Ce():g.vehicleMission.length&&ee(g.vehicleMission))};d(()=>s.isVehicleOnline,()=>{q()}),d(()=>g.vehicleMissionRevision,()=>{q()}),rt(()=>{var e,t;p.disableAutoUpdate(),window.removeEventListener("keydown",Me),o.value&&(o.value.off("contextmenu"),Object.values(b.value).forEach(a=>a.remove()),b.value={}),(e=$.value)==null||e.removeEventListener("touchstart",ue),(t=$.value)==null||t.removeEventListener("touchend",de)}),d(P,(e,t)=>{var a;e.toString()!==t.toString()&&((a=o.value)==null||a.panTo(e))}),d(o,(e,t)=>{o.value!==void 0&&(e==null?void 0:e.options)===void 0&&(o.value=t)}),d(N,(e,t)=>{var a;e!==t&&(M.value=!1,(a=o.value)==null||a.setZoom(N.value))}),d(ie.widget,()=>{var e;(e=o.value)==null||e.invalidateSize()});const H=l(void 0),p=new ct(e=>H.value=e,e=>P.value=e);p.setTrackableTarget(v.VEHICLE,()=>f.value),p.setTrackableTarget(v.HOME,()=>h.value);const f=w(()=>s.coordinates.latitude?[s.coordinates.latitude,s.coordinates.longitude]:void 0),Q=w(()=>{var e;return s.attitude.yaw?ut((e=s.attitude)==null?void 0:e.yaw):0}),xe=w(()=>{const e=s.lastHeartbeat;return e?`${dt(e??0,{includeSeconds:!0})} ago`:"never"}),{history:Be}=vt(f);(Oe=navigator==null?void 0:navigator.geolocation)==null||Oe.watchPosition(e=>{h.value||(h.value=[e.coords.latitude,e.coords.longitude])},e=>console.error(`Failed to get position: (${e.code}) ${e.message}`),{enableHighAccuracy:!1,timeout:5e3,maximumAge:0});let ke=!0;d([h,o],async()=>{h.value===P.value||!o.value||!ke||(p.goToTarget(v.HOME),ke=!1)});const T=l();d(s.coordinates,()=>{if(!(!o.value||!f.value)){if(T.value===void 0){let e=Pt;s.vehicleType===He.MAV_TYPE_SURFACE_BOAT?e=St:s.vehicleType===He.MAV_TYPE_SUBMARINE&&(e=$t);const t=i.divIcon({className:"vehicle-marker",html:`<img src="${e}" style="width: 64px; height: 64px;">`,iconSize:[64,64],iconAnchor:[32,32]});T.value=i.marker(f.value,{icon:t});const a=i.tooltip({content:"No data available",className:"waypoint-tooltip",offset:[40,0]});T.value.bindTooltip(a),o.value.addLayer(T.value)}T.value.setLatLng(f.value)}}),d(f,(e,t)=>{H.value===v.VEHICLE||t!==void 0||p.follow(v.VEHICLE)}),d([f,Q,xe,()=>s.isArmed],()=>{var t,a,n,u,c;if(T.value===void 0)return;(u=T.value.getTooltip())==null||u.setContent(`
    <p>Coordinates: ${(t=f.value)==null?void 0:t[0].toFixed(6)}, ${(a=f.value)==null?void 0:a[1].toFixed(6)}</p>
    <p>Velocity: ${((n=s.velocity.ground)==null?void 0:n.toFixed(2))??"N/A"} m/s</p>
    <p>Heading: ${Q.value.toFixed(2)}°</p>
    <p>${s.isArmed?"Armed":"Disarmed"}</p>
    <p>Last seen: ${xe.value}</p>
  `);const e=(c=T.value.getElement())==null?void 0:c.querySelector("img");e&&(e.style.transform=`rotate(${Q.value}deg)`)});const I=l();d(h,()=>{if(o.value===void 0)return;const e=h.value;if(e!==void 0)if(I.value)I.value.setLatLng(e);else{I.value=i.marker(e,{icon:i.divIcon({className:"marker-icon",iconSize:[24,24],iconAnchor:[12,12]}),draggable:!0});const t=i.tooltip({content:'<i class="mdi mdi-home-map-marker text-[18px] "></i>',permanent:!0,direction:"center",className:"waypoint-tooltip",opacity:1});I.value.bindTooltip(t),I.value.on("dragend",a=>{const u=a.target.getLatLng();te([u.lat,u.lng])}),o.value.addLayer(I.value)}});const D=l();d(Y,e=>{o.value&&(D.value||(D.value=i.polyline([],{color:"#358AC3"}).addTo(o.value)),D.value.setLatLngs(e.map(t=>t.coordinates)),e.forEach((t,a)=>{var c;const n=i.marker(t.coordinates);n.setIcon(i.divIcon({className:"marker-icon",iconSize:[16,16],iconAnchor:[8,8]}));const u=i.tooltip({content:a.toString(),permanent:!0,direction:"center",className:"waypoint-tooltip",opacity:1});n.bindTooltip(u),(c=o.value)==null||c.addLayer(n)}))},{deep:!0});const X=l();d(Be,e=>{if(o.value===void 0||e===void 0)return;X.value===void 0&&(X.value=i.polyline([],{color:"#ffff00"}).addTo(o.value));const t=e.filter(a=>a.snapshot!==void 0).map(a=>a.snapshot);X.value.setLatLngs(t)});const M=l(!1),m=l(null),we=l(),We=mt([{item:"Set home waypoint",action:()=>W("set-home-waypoint"),icon:"mdi-home-map-marker"},{item:"Place Point of Interest",action:()=>W("place-poi"),icon:"mdi-map-marker-plus"},{item:"GoTo",action:()=>W("goto"),icon:"mdi-crosshairs-gps"},{item:"Set default map position",action:()=>W("set-default-map-position"),icon:"mdi-map-check"}]),y=l();let B=!1;const Re=async()=>{var e;if(!(!o.value||!m.value))try{await g.setDefaultMapPosition(m.value,N.value),O({message:"Default map position set",variant:"success"});const t=i.marker(m.value,{icon:i.divIcon({className:"marker-icon",iconSize:[24,24],iconAnchor:[12,12]})}).addTo(o.value),a=i.tooltip({content:'<i class="mdi mdi-map-check text-[18px] border-[1px] rounded-full px-[2px] py-[1px]"></i>',permanent:!0,direction:"center",className:"waypoint-tooltip",opacity:1});t.bindTooltip(a).openTooltip();const n=t.getElement(),u=(e=t.getTooltip())==null?void 0:e.getElement();[n,u].forEach(c=>{c&&(c.style.transition="opacity 1s",c.style.opacity="1")}),setTimeout(()=>{[n,u].forEach(c=>{c&&(c.style.opacity="0")}),setTimeout(()=>{var c;(c=o.value)==null||c.removeLayer(t)},1e3)},1500)}catch(t){console.error(t),O({message:"Failed to set default map position",variant:"error"})}},Ue=()=>{if(!m.value||!o.value)return;y.value&&(o.value.removeLayer(y.value),y.value=void 0),y.value=i.marker(m.value,{icon:i.divIcon({className:"marker-icon",iconSize:[24,24],iconAnchor:[12,12]})}).addTo(o.value);const e=i.tooltip({content:'<i class="mdi mdi-crosshairs-gps border-[1px] rounded-full text-[18px] px-[2px] pt-[1px] "></i>',permanent:!0,direction:"center",className:"waypoint-tooltip",opacity:1});y.value.bindTooltip(e),B=!1,Promise.resolve(Ht(async()=>{B=!0;const[t,a]=m.value,n=s.coordinates.altitude??0;try{await s.goTo(0,0,0,0,t,a,n)}catch(u){O({message:`${u}`,variant:"error"})}},{command:"GoTo"},At(zt.GOTO))).catch(()=>{y.value&&o.value&&(o.value.removeLayer(y.value),y.value=void 0)})},W=async e=>{switch(e){case"goto":{Ue();break}case"set-default-map-position":Re();break;case"place-poi":m.value&&S.value?S.value.openDialog(m.value):m.value?S.value||(O({message:"POI Manager (map widget) is not available.",variant:"error"}),console.error("Cannot open POI dialog, POI Manager (map widget) ref is not set.")):(O({message:"Cannot place Point of Interest without map coordinates.",variant:"error"}),console.error("Cannot open POI dialog without click coordinates for new POI"));break;case"set-home-waypoint":m.value&&te(m.value);break;default:console.warn("Unknown menu option selected:",e)}M.value=!1};d(pt,(e,t)=>{t&&!e&&(!B&&y.value&&o.value&&(o.value.removeLayer(y.value),y.value=void 0),B=!1)});const R=()=>{M.value=!1,o.value!==void 0&&we.value!==void 0&&o.value.removeLayer(we.value)},Me=e=>{e.key==="Escape"&&R()},ee=e=>{e.forEach((t,a)=>{a===0?(h.value=t.coordinates,te(t.coordinates)):Y.value.push(t)})},U=l(!1),Te=l(0),Ce=async()=>{U.value=!0,be();const e=async t=>{Te.value=t};try{const t=await s.fetchMission(e);ee(t),O({variant:"success",message:"Mission download succeeded!",duration:3e3})}catch(t){Ne({variant:"error",title:"Mission download failed",message:t,timer:5e3})}finally{U.value=!1}},te=async e=>{const t=[e[0],e[1]];h.value=t,await s.setHomeWaypoint(t,0),M.value&&(M.value=!1)},Ge=async()=>{try{await s.startMission()}catch{O({message:"Failed to start mission.",variant:"error"})}},_=ft(),Ze=w(()=>`${Math.max(-_.widgetClearanceForVisibleArea(k.value).bottom,0)}px`),Ee=w(()=>`${Math.max(-_.widgetClearanceForVisibleArea(k.value).top,0)}px`),je=w(()=>s.isVehicleOnline?"Download the mission that is stored in the vehicle.":"Cannot download mission (vehicle offline)."),Ye=w(()=>s.isVehicleOnline?"Execute the mission that is stored in the vehicle.":"Cannot execute mission (vehicle offline)."),Je=w(()=>h.value===void 0?"Cannot center map on home (home position undefined).":H.value===v.HOME?"Tracking home position. Click to stop tracking.":"Click once to center on home or twice to track it."),Ke=w(()=>s.isVehicleOnline?f.value===void 0?"Cannot center map on vehicle (vehicle position undefined).":H.value===v.VEHICLE?"Tracking vehicle position. Click to stop tracking.":"Click once to center on vehicle or twice to track it.":"Cannot center map on vehicle (vehicle offline)."),Le=e=>({html:`
    <div class="poi-marker-container">
      <div class="poi-marker-background" style="background-color: ${e.color}80;"></div>
      <i class="v-icon notranslate mdi ${e.icon}" style="color: rgba(255, 255, 255, 0.7); position: relative; z-index: 2;"></i>
    </div>
  `,className:"poi-marker-icon-widget",iconSize:[32,32],iconAnchor:[16,32]}),Ve=e=>{if(!o.value||!o.value.getContainer())return;const t=i.divIcon(Le(e)),a=i.marker(e.coordinates,{icon:t,draggable:!0}).addTo(o.value),n=`
    <strong>${e.name}</strong><br>
    ${e.description?e.description+"<br>":""}
    Lat: ${e.coordinates[0].toFixed(8)}, Lng: ${e.coordinates[1].toFixed(8)}
  `,u={permanent:!1,direction:"top",offset:[-14,-64],className:"poi-tooltip-widget"};a.bindTooltip(n,u),a.on("drag",c=>{var Pe;const C=c.target.getLatLng(),oe=`
      <strong>${e.name}</strong><br>
      ${e.description?e.description+"<br>":""}
      Lat: ${C.lat.toFixed(8)}, Lng: ${C.lng.toFixed(8)}
    `;(Pe=a.getTooltip())==null||Pe.setContent(oe)}),a.on("dragend",c=>{const C=c.target.getLatLng();g.movePointOfInterest(e.id,[C.lat,C.lng])}),a.on("click",c=>{if(i.DomEvent.stopPropagation(c),S.value){const C=g.pointsOfInterest.find(oe=>oe.id===e.id);C?S.value.openDialog(void 0,C):console.warn("POI not found in store:",e.id)}}),b.value[e.id]=a},Ie=e=>{var n;if(!o.value||!o.value.getContainer()||!b.value[e.id])return;const t=b.value[e.id];t.setLatLng(e.coordinates),t.setIcon(i.divIcon(Le(e)));const a=`
    <strong>${e.name}</strong><br>
    ${e.description?e.description+"<br>":""}
    Lat: ${e.coordinates[0].toFixed(8)}, Lng: ${e.coordinates[1].toFixed(8)}
  `;(n=t.getTooltip())==null||n.setContent(a)},qe=e=>{!o.value||!b.value[e]||(b.value[e].remove(),delete b.value[e])};return d(()=>g.pointsOfInterest,async e=>{if((!o.value||!o.value.getContainer())&&(await gt(),!o.value||!o.value.getContainer())){console.warn("Map.vue: POI watcher - map not ready after nextTick.");return}const t=new Set(e.map(a=>a.id));Object.keys(b.value).forEach(a=>{t.has(a)||qe(a)}),e.forEach(a=>{b.value[a.id]?Ie(a):Ve(a)})},{deep:!0,immediate:!0}),d(o,e=>{e&&e.getContainer()&&g.pointsOfInterest.forEach(t=>{b.value[t.id]?Ie(t):Ve(t)})},{immediate:!0}),(e,t)=>{const a=ht("contextmenu");return E(),ae(Ot,null,[yt((E(),ae("div",{ref_key:"mapBase",ref:$,class:bt(["page-base",r(_).editingMode?"pointer-events-none":"pointer-events-auto"])},[xt("div",{id:se.value,ref_key:"map",ref:o,class:"map"},[x(j,{location:"top",text:Je.value},{activator:L(({props:n})=>[V.value?(E(),F(G,Z({key:0},n,{class:["absolute right-[166px] m-3 bottom-button bg-slate-50 text-[14px]",h.value?"":"active-events-on-disabled"],color:H.value==r(v).HOME?"red":"",elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-home-search",size:"x-small",disabled:!h.value,onClick:t[0]||(t[0]=A(u=>r(p).goToTarget(r(v).HOME,!0),["stop"])),onDblclick:t[1]||(t[1]=A(u=>r(p).follow(r(v).HOME),["stop"]))}),null,16,["class","color","disabled"])):z("",!0)]),_:1},8,["text"]),x(j,{location:"top",text:Ke.value},{activator:L(({props:n})=>[V.value?(E(),F(G,Z({key:0},n,{class:["absolute m-3 bottom-button right-[124px] bg-slate-50 text-[14px]",f.value?"":"active-events-on-disabled"],color:H.value==r(v).VEHICLE?"red":"",elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-airplane-marker",size:"x-small",disabled:!f.value,onClick:t[2]||(t[2]=A(u=>r(p).goToTarget(r(v).VEHICLE,!0),["stop"])),onDblclick:t[3]||(t[3]=A(u=>r(p).follow(r(v).VEHICLE),["stop"]))}),null,16,["class","color","disabled"])):z("",!0)]),_:1},8,["text"]),x(j,{location:"top",text:je.value},{activator:L(({props:n})=>[V.value?(E(),F(G,Z({key:0},n,{class:["absolute m-3 bottom-button right-[82px] bg-slate-50 text-[14px]",r(s).isVehicleOnline?"":"active-events-on-disabled"],disabled:!r(s).isVehicleOnline,elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-download",size:"x-small",onClick:A(Ce,["stop"])}),null,16,["class","disabled"])):z("",!0)]),_:1},8,["text"]),x(j,{location:"top",text:Ye.value},{activator:L(({props:n})=>[V.value?(E(),F(G,Z({key:0},n,{class:["absolute mb-3 ml-1 bottom-button right-[52px] bg-slate-50 text-[14px]",r(s).isVehicleOnline?"":"active-events-on-disabled"],disabled:!r(s).isVehicleOnline,elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-play",size:"x-small",onClick:A(Ge,["stop"])}),null,16,["class","disabled"])):z("",!0)]),_:1},8,["text"])],8,_t)],2)),[[a,De]]),x(kt,{ref_key:"contextMenuRef",ref:re,visible:M.value,width:"260px","menu-items":We,onClose:R},null,8,["visible","menu-items"]),x(Lt,{modelValue:r(_).widgetManagerVars(r(k).hash).configMenuOpen,"onUpdate:modelValue":t[5]||(t[5]=n=>r(_).widgetManagerVars(r(k).hash).configMenuOpen=n),width:"auto"},{default:L(()=>[x(wt,{class:"pa-2",style:ne(r(ze).globalGlassMenuStyles)},{default:L(()=>[x(Mt,{class:"text-center"},{default:L(()=>t[6]||(t[6]=[Tt("Map widget settings")])),_:1}),x(Ct,null,{default:L(()=>[x(Et,{modelValue:r(k).options.showVehiclePath,"onUpdate:modelValue":t[4]||(t[4]=n=>r(k).options.showVehiclePath=n),class:"my-1",label:"Show vehicle path",color:r(k).options.showVehiclePath?"white":void 0,"hide-details":""},null,8,["modelValue","color"])]),_:1})]),_:1},8,["style"])]),_:1},8,["modelValue"]),U.value?(E(),F(Vt,{key:0,"model-value":Te.value,height:"10",absolute:"",bottom:"",color:"white",style:ne(`top: ${Ee.value}`)},null,8,["model-value","style"])):z("",!0),U.value?(E(),ae("p",{key:1,style:ne({top:Ee.value}),class:"absolute left-[7px] mt-4 flex text-md font-bold text-white z-30 drop-shadow-md"}," Loading mission... ",4)):z("",!0),x(It,{ref_key:"poiManagerMapWidgetRef",ref:S},null,512)],64)}}}),Bt=Nt(Ft,[["__scopeId","data-v-b6704c40"]]);export{Bt as default};
