import{bF as Ee,bG as $e,bH as Pe,bI as K,f as Be,bJ as ke,bK as Fe,bL as Ue,c as Re,bv as Xe,J as We,K as Ye,a8 as Ze,u as Ge,ak as qe,r as m,k as w,M as we,Y as Te,L as Ke,bM as u,j as je,w as y,o as Je,bN as f,ae as Qe,bO as et,aI as tt,bP as at,bQ as Ce,aF as ot,y as nt,l as S,m as ie,n as U,H as E,N as L,I as R,a6 as j,a0 as J,q as r,au as D,s as H,a1 as Q,v as lt,O as ee,V as it,P as st,Q as rt,R as ut,a5 as ct,W as dt,bR as vt,F as mt,z as ft,B as pt,E as gt,bS as se,_ as ht}from"./index-CJDrwU8l.js";function Ie(g,x){if(g==null)throw new TypeError("assign requires that input parameter not be null or undefined");for(var i in x)Object.prototype.hasOwnProperty.call(x,i)&&(g[i]=x[i]);return g}function bt(g){return Ie({},g)}var Ve=1440,yt=2520,re=43200,xt=86400;function Mt(g,x,i){var P,B;Ee(2,arguments);var n=Ue(),l=(P=(B=i==null?void 0:i.locale)!==null&&B!==void 0?B:n.locale)!==null&&P!==void 0?P:$e;if(!l.formatDistance)throw new RangeError("locale must contain formatDistance property");var a=Pe(g,x);if(isNaN(a))throw new RangeError("Invalid time value");var s=Ie(bt(i),{addSuffix:!!(i!=null&&i.addSuffix),comparison:a}),p,d;a>0?(p=K(x),d=K(g)):(p=K(g),d=K(x));var T=Be(d,p),C=(ke(d)-ke(p))/1e3,v=Math.round((T-C)/60),V;if(v<2)return i!=null&&i.includeSeconds?T<5?l.formatDistance("lessThanXSeconds",5,s):T<10?l.formatDistance("lessThanXSeconds",10,s):T<20?l.formatDistance("lessThanXSeconds",20,s):T<40?l.formatDistance("halfAMinute",0,s):T<60?l.formatDistance("lessThanXMinutes",1,s):l.formatDistance("xMinutes",1,s):v===0?l.formatDistance("lessThanXMinutes",1,s):l.formatDistance("xMinutes",v,s);if(v<45)return l.formatDistance("xMinutes",v,s);if(v<90)return l.formatDistance("aboutXHours",1,s);if(v<Ve){var X=Math.round(v/60);return l.formatDistance("aboutXHours",X,s)}else{if(v<yt)return l.formatDistance("xDays",1,s);if(v<re){var W=Math.round(v/Ve);return l.formatDistance("xDays",W,s)}else if(v<xt)return V=Math.round(v/re),l.formatDistance("aboutXMonths",V,s)}if(V=Fe(d,p),V<12){var te=Math.round(v/re);return l.formatDistance("xMonths",te,s)}else{var Y=V%12,N=Math.floor(V/12);return Y<3?l.formatDistance("aboutXYears",N,s):Y<9?l.formatDistance("overXYears",N,s):l.formatDistance("almostXYears",N+1,s)}}function kt(g,x){return Ee(1,arguments),Mt(g,Date.now(),x)}const wt=""+new URL("blueboat-marker-DyHmCFOq.png",import.meta.url).href,Tt=""+new URL("brov2-marker-CBzp11FX.png",import.meta.url).href,Ct=""+new URL("generic-vehicle-marker-SovxT5Tc.png",import.meta.url).href,Vt=["id"],Et=Re({__name:"Map",props:{widget:{}},setup(g){var Me;Xe(e=>({a4178300:De.value}));const x=g,i=We(x).widget,P=Ye(),{showDialog:B}=Ze(),n=Ge(),l=qe(),a=m(),s=m(l.defaultMapZoom),p=m(l.defaultMapCenter),d=m(),T=w(()=>`map-${i.value.hash}`),C=m(!1);we.registerUsage(Te.latitude),we.registerUsage(Te.longitude),Ke(()=>{Object.keys(i.value.options).length===0&&(i.value.options={showVehiclePath:!0}),h.enableAutoUpdate()});const v=u.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:23,maxNativeZoom:19,attribution:"© OpenStreetMap"}),V=u.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{maxZoom:23,maxNativeZoom:19,attribution:"© Esri World Imagery"}),X=u.tileLayer("https://tiles.openseamap.org/seamark/{z}/{x}/{y}.png",{maxZoom:18,attribution:"© OpenSeaMap contributors"}),W=u.tileLayer.wms("https://geoserver.openseamap.org/geoserver/gwc/service/wms",{layers:"gebco2021:gebco_2021",format:"image/png",transparent:!0,version:"1.1.1",attribution:"© GEBCO, OpenSeaMap",tileSize:256,maxZoom:19}),te={OpenStreetMap:v,"Esri World Imagery":V},Y={Seamarks:X,"Marine Profile":W},N=m(),ue=je(N),ce=u.control.zoom({position:"bottomright"}),de=u.control.layers(te,Y);y(C,()=>{a.value!==void 0&&(C.value?(a.value.addControl(ce),a.value.addControl(de)):(a.value.removeControl(ce),a.value.removeControl(de)))}),y(ue,()=>{C.value=ue.value}),Je(async()=>{a.value=u.map(T.value,{layers:[v,V,X,W],attributionControl:!1}).setView(p.value,s.value),a.value.removeControl(a.value.zoomControl),a.value.on("moveend",()=>{if(a.value===void 0)return;let{lat:e,lng:t}=a.value.getCenter();e&&t&&(p.value=[e,t])}),a.value.on("zoomend",()=>{var e;a.value!==void 0&&(s.value=((e=a.value)==null?void 0:e.getZoom())??p.value)}),a.value.on("click",()=>{a.value!==void 0&&a.value.on("click",fe)}),a.value.on("contextmenu",()=>{ge()}),h.enableAutoUpdate(),window.addEventListener("keydown",he),b.value?h.goToTarget(f.VEHICLE):h.goToTarget(f.HOME)}),Qe(()=>{h.disableAutoUpdate(),window.removeEventListener("keydown",he),a.value&&(a.value.off("click",fe),a.value.off("contextmenu"))}),y(p,(e,t)=>{var o;e.toString()!==t.toString()&&((o=a.value)==null||o.panTo(e))}),y(a,(e,t)=>{a.value!==void 0&&(e==null?void 0:e.options)===void 0&&(a.value=t)}),y(s,(e,t)=>{var o;e!==t&&((o=a.value)==null||o.setZoom(s.value))}),y(x.widget,()=>{var e;(e=a.value)==null||e.invalidateSize()});const A=m(void 0),h=new et(e=>A.value=e,e=>p.value=e);h.setTrackableTarget(f.VEHICLE,()=>b.value),h.setTrackableTarget(f.HOME,()=>d.value);const b=w(()=>n.coordinates.latitude?[n.coordinates.latitude,n.coordinates.longitude]:void 0),ae=w(()=>{var e;return n.attitude.yaw?tt((e=n.attitude)==null?void 0:e.yaw):0}),ve=w(()=>{const e=n.lastHeartbeat;return e?`${kt(e??0,{includeSeconds:!0})} ago`:"never"}),{history:Se}=at(b);(Me=navigator==null?void 0:navigator.geolocation)==null||Me.watchPosition(e=>d.value=[e.coords.latitude,e.coords.longitude],e=>console.error(`Failed to get position: (${e.code}) ${e.message}`),{enableHighAccuracy:!1,timeout:5e3,maximumAge:0});let me=!0;y([d,a],async()=>{d.value===p.value||!a.value||!me||(h.goToTarget(f.HOME),me=!1)});const I=m();y(n.coordinates,()=>{if(!(!a.value||!b.value)){if(I.value===void 0){let e=Ct;n.vehicleType===Ce.MAV_TYPE_SURFACE_BOAT?e=wt:n.vehicleType===Ce.MAV_TYPE_SUBMARINE&&(e=Tt);const t=u.divIcon({className:"vehicle-marker",html:`<img src="${e}" style="width: 64px; height: 64px;">`,iconSize:[64,64],iconAnchor:[32,32]});I.value=u.marker(b.value,{icon:t});const o=u.tooltip({content:"No data available",className:"waypoint-tooltip",offset:[40,0]});I.value.bindTooltip(o),a.value.addLayer(I.value)}I.value.setLatLng(b.value)}}),y(b,(e,t)=>{A.value===f.VEHICLE||t!==void 0||h.follow(f.VEHICLE)}),y([b,ae,ve,()=>n.isArmed],()=>{var t,o,c,M,k;if(I.value===void 0)return;(M=I.value.getTooltip())==null||M.setContent(`
    <p>Coordinates: ${(t=b.value)==null?void 0:t[0].toFixed(6)}, ${(o=b.value)==null?void 0:o[1].toFixed(6)}</p>
    <p>Velocity: ${((c=n.velocity.ground)==null?void 0:c.toFixed(2))??"N/A"} m/s</p>
    <p>Heading: ${ae.value.toFixed(2)}°</p>
    <p>${n.isArmed?"Armed":"Disarmed"}</p>
    <p>Last seen: ${ve.value}</p>
  `);const e=(k=I.value.getElement())==null?void 0:k.querySelector("img");e&&(e.style.transform=`rotate(${ae.value}deg)`)});const z=m();y(d,()=>{if(a.value===void 0)return;const e=d.value;if(e!==void 0)if(z.value)z.value.setLatLng(e);else{z.value=u.marker(e,{icon:u.divIcon({className:"marker-icon",iconSize:[24,24],iconAnchor:[12,12]}),draggable:!0});const t=u.tooltip({content:'<i class="mdi mdi-home-map-marker text-[18px]"></i>',permanent:!0,direction:"center",className:"waypoint-tooltip",opacity:1});z.value.bindTooltip(t),z.value.on("dragend",o=>{const M=o.target.getLatLng();ye([M.lat,M.lng])}),a.value.addLayer(z.value)}});const oe=m();y(l.currentPlanningWaypoints,e=>{if(a.value!==void 0){if(oe.value===void 0){const t=e.map(o=>o.coordinates);oe.value=u.polyline(t,{color:"#358AC3"}).addTo(a.value)}oe.value.setLatLngs(e.map(t=>t.coordinates)),e.forEach((t,o)=>{var $;const c=u.marker(t.coordinates),M=u.divIcon({className:"marker-icon",iconSize:[16,16],iconAnchor:[8,8]});c.setIcon(M);const k=u.tooltip({content:o.toString(),permanent:!0,direction:"center",className:"waypoint-tooltip",opacity:1});c.bindTooltip(k),($=a.value)==null||$.addLayer(c)})}});const ne=m();y(Se,e=>{if(a.value===void 0||e===void 0)return;ne.value===void 0&&(ne.value=u.polyline([],{color:"#ffff00"}).addTo(a.value));const t=e.filter(o=>o.snapshot!==void 0).map(o=>o.snapshot);ne.value.setLatLngs(t)});const Z=m(!1),_=m(null),G=ot({top:"0px",left:"0px"}),O=m(),fe=e=>{var t,o,c,M;if(O.value!==void 0&&a.value!==void 0&&((t=O.value)==null||t.removeFrom(a.value)),((o=e==null?void 0:e.latlng)==null?void 0:o.lat)!=null&&((c=e==null?void 0:e.latlng)==null?void 0:c.lng)!=null){_.value=[e.latlng.lat,e.latlng.lng],Z.value=!0;const k=(M=a.value)==null?void 0:M.getContainer();if(k){const{x:$,y:le}=k.getBoundingClientRect();G.left=`${e.originalEvent.clientX-$}px`,G.top=`${e.originalEvent.clientY-le}px`}}else console.error("Invalid event structure:",e);if(a.value!==void 0){O.value=u.marker(_.value);const k=u.divIcon({className:"marker-icon",iconSize:[32,32],iconAnchor:[16,16]});O.value.setIcon(k),a.value.addLayer(O.value)}},pe=e=>{switch(e){case"goto":if(_.value){const k=n.coordinates.altitude??0,$=_.value[0],le=_.value[1];ft(async()=>{try{await n.goTo(0,0,0,0,$,le,k)}catch(_e){se({message:_e,variant:"error"})}},{command:"GoTo"},pt(gt.GOTO))}break;case"set-default-map-position":l.setDefaultMapPosition(p.value,s.value);break;default:console.warn("Unknown menu option selected:",e)}Z.value=!1},ge=()=>{Z.value=!1,_.value=null,a.value!==void 0&&O.value!==void 0&&a.value.removeLayer(O.value)},he=e=>{e.key==="Escape"&&ge()},q=m(!1),be=m(0),Le=async()=>{q.value=!0;const e=async t=>{be.value=t};l.clearMission();try{(await n.fetchMission(e)).forEach((o,c)=>{c===0&&(d.value=o.coordinates,ye(o.coordinates)),c>0&&l.currentPlanningWaypoints.push(o)}),se({variant:"success",message:"Mission download succeeded!",duration:3e3})}catch(t){B({variant:"error",title:"Mission download failed",message:t,timer:5e3})}finally{q.value=!1}},ye=async e=>{const t=[e[0],e[1]];d.value=t,a.value&&a.value.setView(t,s.value),p.value=t,await n.setHomeWaypoint(t,0)},Oe=async()=>{try{await n.startMission()}catch{se({message:"Failed to start mission.",variant:"error"})}},F=nt(),De=w(()=>`${Math.max(-F.widgetClearanceForVisibleArea(i.value).bottom,0)}px`),xe=w(()=>`${Math.max(-F.widgetClearanceForVisibleArea(i.value).top,0)}px`),He=w(()=>n.isVehicleOnline?"Download the mission that is stored in the vehicle.":"Cannot download mission (vehicle offline)."),Ne=w(()=>n.isVehicleOnline?"Execute the mission that is stored in the vehicle.":"Cannot execute mission (vehicle offline)."),Ae=w(()=>d.value===void 0?"Cannot center map on home (home position undefined).":A.value===f.HOME?"Tracking home position. Click to stop tracking.":"Click once to center on home or twice to track it."),ze=w(()=>n.isVehicleOnline?b.value===void 0?"Cannot center map on vehicle (vehicle position undefined).":A.value===f.VEHICLE?"Tracking vehicle position. Click to stop tracking.":"Click once to center on vehicle or twice to track it.":"Cannot center map on vehicle (vehicle offline).");return(e,t)=>(S(),ie(mt,null,[U("div",{ref_key:"mapBase",ref:N,class:lt(["page-base",r(F).editingMode?"pointer-events-none":"pointer-events-auto"])},[U("div",{id:T.value,ref_key:"map",ref:a,class:"map"},[E(Q,{location:"top",text:Ae.value},{activator:L(({props:o})=>[C.value?(S(),R(j,J({key:0},o,{class:["absolute right-[166px] m-3 bottom-button bg-slate-50",d.value?"":"active-events-on-disabled"],color:A.value==r(f).HOME?"red":"",elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-home-map-marker",size:"x-small",disabled:!d.value,onClick:t[0]||(t[0]=D(c=>r(h).goToTarget(r(f).HOME,!0),["stop"])),onDblclick:t[1]||(t[1]=D(c=>r(h).follow(r(f).HOME),["stop"]))}),null,16,["class","color","disabled"])):H("",!0)]),_:1},8,["text"]),E(Q,{location:"top",text:ze.value},{activator:L(({props:o})=>[C.value?(S(),R(j,J({key:0},o,{class:["absolute m-3 bottom-button right-[124px] bg-slate-50",b.value?"":"active-events-on-disabled"],color:A.value==r(f).VEHICLE?"red":"",elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-airplane-marker",size:"x-small",disabled:!b.value,onClick:t[2]||(t[2]=D(c=>r(h).goToTarget(r(f).VEHICLE,!0),["stop"])),onDblclick:t[3]||(t[3]=D(c=>r(h).follow(r(f).VEHICLE),["stop"]))}),null,16,["class","color","disabled"])):H("",!0)]),_:1},8,["text"]),E(Q,{location:"top",text:He.value},{activator:L(({props:o})=>[C.value?(S(),R(j,J({key:0},o,{class:["absolute m-3 bottom-button right-[82px] bg-slate-50",r(n).isVehicleOnline?"":"active-events-on-disabled"],disabled:!r(n).isVehicleOnline,elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-download",size:"x-small",onClick:D(Le,["stop"])}),null,16,["class","disabled"])):H("",!0)]),_:1},8,["text"]),E(Q,{location:"top",text:Ne.value},{activator:L(({props:o})=>[C.value?(S(),R(j,J({key:0},o,{class:["absolute mb-3 ml-1 bottom-button right-[52px] bg-slate-50",r(n).isVehicleOnline?"":"active-events-on-disabled"],disabled:!r(n).isVehicleOnline,elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-play",size:"x-small",onClick:D(Oe,["stop"])}),null,16,["class","disabled"])):H("",!0)]),_:1},8,["text"])],8,Vt)],2),Z.value?(S(),ie("div",{key:0,class:"context-menu",style:ee({top:G.top,left:G.left})},[U("ul",{onClick:t[6]||(t[6]=D(()=>{},["stop"]))},[U("li",{onClick:t[4]||(t[4]=o=>pe("goto"))},"GoTo"),U("li",{onClick:t[5]||(t[5]=o=>pe("set-default-map-position"))},"Set default map position")])],4)):H("",!0),E(dt,{modelValue:r(F).widgetManagerVars(r(i).hash).configMenuOpen,"onUpdate:modelValue":t[8]||(t[8]=o=>r(F).widgetManagerVars(r(i).hash).configMenuOpen=o),width:"auto"},{default:L(()=>[E(it,{class:"pa-2",style:ee(r(P).globalGlassMenuStyles)},{default:L(()=>[E(st,{class:"text-center"},{default:L(()=>t[9]||(t[9]=[rt("Map widget settings")])),_:1}),E(ut,null,{default:L(()=>[E(ct,{modelValue:r(i).options.showVehiclePath,"onUpdate:modelValue":t[7]||(t[7]=o=>r(i).options.showVehiclePath=o),class:"my-1",label:"Show vehicle path",color:r(i).options.showVehiclePath?"white":void 0,"hide-details":""},null,8,["modelValue","color"])]),_:1})]),_:1},8,["style"])]),_:1},8,["modelValue"]),q.value?(S(),R(vt,{key:1,"model-value":be.value,height:"10",absolute:"",bottom:"",color:"white",style:ee(`top: ${xe.value}`)},null,8,["model-value","style"])):H("",!0),q.value?(S(),ie("p",{key:2,style:ee({top:xe.value}),class:"absolute left-[7px] mt-4 flex text-md font-bold text-white z-30 drop-shadow-md"}," Loading mission... ",4)):H("",!0)],64))}}),St=ht(Et,[["__scopeId","data-v-e7def4c9"]]);export{St as default};
