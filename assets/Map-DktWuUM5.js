import{c as Qe,bv as Xe,J as et,K as tt,a8 as ot,u as at,ak as nt,r as l,k as w,M as Pe,Y as $e,L as it,bF as i,j as st,w as u,o as lt,bG as m,ae as rt,bH as ct,aJ as ut,bI as dt,bJ as vt,bK as He,aG as mt,bL as O,bM as pt,y as ft,aN as gt,be as ht,l as L,m as ne,G as yt,v as bt,q as c,n as xt,H as b,N as E,I as D,a6 as j,a0 as Y,au as A,s as z,a1 as q,bN as kt,V as wt,O as ie,P as Mt,Q as Tt,R as Ct,a5 as Lt,W as Et,bO as Vt,bP as It,F as Ot,bQ as St,bR as Pt,bS as $t,_ as Ht}from"./index-q419Qo-D.js";const At=["id"],zt=Qe({__name:"Map",props:{widget:{}},setup(Ae){var Se;Xe(e=>({c1e25482:Ze.value}));const se=Ae,x=et(se).widget,ze=tt(),{showDialog:Ne}=ot(),s=at(),g=nt(),o=l(),N=l(g.defaultMapZoom),S=l(g.defaultMapCenter),h=l(),le=w(()=>`map-${x.value.hash}`),V=l(!1),re=l(!1),J=l([]),ce=l(),K=l(!1),Q=l(!1);let ue;const de=e=>{e.touches.length>1&&(Q.value=!0,M.value&&U(),clearTimeout(ue))},ve=e=>{e.touches.length<=1&&(ue=window.setTimeout(()=>Q.value=!1,300))},P=l(null),y=l({});Pe.registerUsage($e.latitude),Pe.registerUsage($e.longitude),it(()=>{Object.keys(x.value.options).length===0&&(x.value.options={showVehiclePath:!0}),p.enableAutoUpdate()});const me=i.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:23,maxNativeZoom:19,attribution:"© OpenStreetMap"}),pe=i.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{maxZoom:23,maxNativeZoom:19,attribution:"© Esri World Imagery"}),fe=i.tileLayer("https://tiles.openseamap.org/seamark/{z}/{x}/{y}.png",{maxZoom:18,attribution:"© OpenSeaMap contributors"}),ge=i.tileLayer.wms("https://geoserver.openseamap.org/geoserver/gwc/service/wms",{layers:"gebco2021:gebco_2021",format:"image/png",transparent:!0,version:"1.1.1",attribution:"© GEBCO, OpenSeaMap",tileSize:256,maxZoom:19}),_e={OpenStreetMap:me,"Esri World Imagery":pe},Fe={Seamarks:fe,"Marine Profile":ge},$=l(),he=st($),ye=i.control.zoom({position:"bottomright"}),be=i.control.layers(_e,Fe);u(V,()=>{o.value!==void 0&&(V.value?(o.value.addControl(ye),o.value.addControl(be)):(o.value.removeControl(ye),o.value.removeControl(be)))}),u(he,()=>{V.value=he.value}),lt(async()=>{var e,t;(e=$.value)==null||e.addEventListener("touchstart",de,{passive:!0}),(t=$.value)==null||t.addEventListener("touchend",ve,{passive:!0}),o.value=i.map(le.value,{layers:[me,pe,fe,ge],attributionControl:!1}).setView(S.value,N.value),o.value.removeControl(o.value.zoomControl),o.value.on("click",a=>{v.value=[a.latlng.lat,a.latlng.lng]}),o.value.on("moveend",()=>{if(o.value===void 0)return;let{lat:a,lng:n}=o.value.getCenter();a&&n&&(S.value=[a,n])}),o.value.on("dragstart",()=>{K.value=!0}),o.value.on("dragend",()=>{setTimeout(()=>K.value=!1,200)}),o.value.on("zoomend",()=>{var a;M.value=!1,o.value!==void 0&&(N.value=((a=o.value)==null?void 0:a.getZoom())??S.value)}),o.value.on("contextmenu",a=>{v.value=[a.latlng.lat,a.latlng.lng]}),p.enableAutoUpdate(),window.addEventListener("keydown",Te),f.value?p.goToTarget(m.VEHICLE):p.goToTarget(m.HOME),!s.isVehicleOnline&&g.vehicleMission.length&&oe(g.vehicleMission),re.value=!0,await X()});const De={open:e=>{if(!o.value||Q.value||K.value)return;e.preventDefault(),e.stopPropagation();const t=o.value.mouseEventToContainerPoint(e),a=o.value.containerPointToLatLng(t);v.value=[a.lat,a.lng],ce.value.openAt(e),M.value=!0},close:()=>{U()}},xe=()=>{var e;(e=o.value)==null||e.eachLayer(t=>{(t instanceof i.Marker||t instanceof i.Polyline&&t.options.color==="#358AC3")&&o.value.removeLayer(t)}),J.value=[],B.value=void 0,I.value=void 0,T.value=void 0},X=async()=>{re.value&&(xe(),s.isVehicleOnline?await Le():g.vehicleMission.length&&oe(g.vehicleMission))};u(()=>s.isVehicleOnline,()=>{X()}),u(()=>g.vehicleMissionRevision,()=>{X()}),rt(()=>{var e,t;p.disableAutoUpdate(),window.removeEventListener("keydown",Te),o.value&&(o.value.off("contextmenu"),Object.values(y.value).forEach(a=>a.remove()),y.value={}),(e=$.value)==null||e.removeEventListener("touchstart",de),(t=$.value)==null||t.removeEventListener("touchend",ve)}),u(S,(e,t)=>{var a;e.toString()!==t.toString()&&((a=o.value)==null||a.panTo(e))}),u(o,(e,t)=>{o.value!==void 0&&(e==null?void 0:e.options)===void 0&&(o.value=t)}),u(N,(e,t)=>{var a;e!==t&&(M.value=!1,(a=o.value)==null||a.setZoom(N.value))}),u(se.widget,()=>{var e;(e=o.value)==null||e.invalidateSize()});const H=l(void 0),p=new ct(e=>H.value=e,e=>S.value=e);p.setTrackableTarget(m.VEHICLE,()=>f.value),p.setTrackableTarget(m.HOME,()=>h.value);const f=w(()=>s.coordinates.latitude?[s.coordinates.latitude,s.coordinates.longitude]:void 0),ee=w(()=>{var e;return s.attitude.yaw?ut((e=s.attitude)==null?void 0:e.yaw):0}),ke=w(()=>{const e=s.lastHeartbeat;return e?`${dt(e??0,{includeSeconds:!0})} ago`:"never"}),{history:Be}=vt(f);(Se=navigator==null?void 0:navigator.geolocation)==null||Se.watchPosition(e=>{h.value||(h.value=[e.coords.latitude,e.coords.longitude])},e=>console.error(`Failed to get position: (${e.code}) ${e.message}`),{enableHighAccuracy:!1,timeout:5e3,maximumAge:0});let we=!0;u([h,o],async()=>{h.value===S.value||!o.value||!we||(p.goToTarget(m.HOME),we=!1)});const C=l();u(s.coordinates,()=>{if(!(!o.value||!f.value)){if(C.value===void 0){let e=St;s.vehicleType===He.MAV_TYPE_SURFACE_BOAT?e=Pt:s.vehicleType===He.MAV_TYPE_SUBMARINE&&(e=$t);const t=i.divIcon({className:"vehicle-marker",html:`<img src="${e}" style="width: 64px; height: 64px;">`,iconSize:[64,64],iconAnchor:[32,32]});C.value=i.marker(f.value,{icon:t});const a=i.tooltip({content:"No data available",className:"waypoint-tooltip",offset:[40,0]});C.value.bindTooltip(a),o.value.addLayer(C.value)}C.value.setLatLng(f.value)}}),u(f,(e,t)=>{H.value===m.VEHICLE||t!==void 0||p.follow(m.VEHICLE)}),u([f,ee,ke,()=>s.isArmed],()=>{var t,a,n,d,r;if(C.value===void 0)return;(d=C.value.getTooltip())==null||d.setContent(`
    <p>Coordinates: ${(t=f.value)==null?void 0:t[0].toFixed(6)}, ${(a=f.value)==null?void 0:a[1].toFixed(6)}</p>
    <p>Velocity: ${((n=s.velocity.ground)==null?void 0:n.toFixed(2))??"N/A"} m/s</p>
    <p>Heading: ${ee.value.toFixed(2)}°</p>
    <p>${s.isArmed?"Armed":"Disarmed"}</p>
    <p>Last seen: ${ke.value}</p>
  `);const e=(r=C.value.getElement())==null?void 0:r.querySelector("img");e&&(e.style.transform=`rotate(${ee.value}deg)`)});const I=l();u(h,()=>{if(o.value===void 0)return;const e=h.value;if(e!==void 0)if(I.value)I.value.setLatLng(e);else{I.value=i.marker(e,{icon:i.divIcon({className:"marker-icon",iconSize:[24,24],iconAnchor:[12,12]}),draggable:!0});const t=i.tooltip({content:'<i class="mdi mdi-home-map-marker text-[18px] "></i>',permanent:!0,direction:"center",className:"waypoint-tooltip",opacity:1});I.value.bindTooltip(t),I.value.on("dragend",a=>{const d=a.target.getLatLng();ae([d.lat,d.lng])}),o.value.addLayer(I.value)}});const B=l();u(J,e=>{o.value&&(B.value||(B.value=i.polyline([],{color:"#358AC3"}).addTo(o.value)),B.value.setLatLngs(e.map(t=>t.coordinates)),e.forEach((t,a)=>{var r;const n=i.marker(t.coordinates);n.setIcon(i.divIcon({className:"marker-icon",iconSize:[16,16],iconAnchor:[8,8]}));const d=i.tooltip({content:a.toString(),permanent:!0,direction:"center",className:"waypoint-tooltip",opacity:1});n.bindTooltip(d),(r=o.value)==null||r.addLayer(n)}))},{deep:!0});const te=l();u(Be,e=>{if(o.value===void 0||e===void 0)return;te.value===void 0&&(te.value=i.polyline([],{color:"#ffff00"}).addTo(o.value));const t=e.filter(a=>a.snapshot!==void 0).map(a=>a.snapshot);te.value.setLatLngs(t)});const M=l(!1),v=l(null),Me=l(),Re=mt([{item:"Set home waypoint",action:()=>W("set-home-waypoint"),icon:"mdi-home-map-marker"},{item:"Place Point of Interest",action:()=>W("place-poi"),icon:"mdi-map-marker-plus"},{item:"GoTo",action:()=>W("goto"),icon:"mdi-crosshairs-gps"},{item:"Set default map position",action:()=>W("set-default-map-position"),icon:"mdi-map-check"}]),T=l();let R=!1;const We=async()=>{var e;if(!(!o.value||!v.value))try{await g.setDefaultMapPosition(v.value,N.value),O({message:"Default map position set",variant:"success"});const t=i.marker(v.value,{icon:i.divIcon({className:"marker-icon",iconSize:[24,24],iconAnchor:[12,12]})}).addTo(o.value),a=i.tooltip({content:'<i class="mdi mdi-map-check text-[18px] border-[1px] rounded-full px-[2px] py-[1px]"></i>',permanent:!0,direction:"center",className:"waypoint-tooltip",opacity:1});t.bindTooltip(a).openTooltip();const n=t.getElement(),d=(e=t.getTooltip())==null?void 0:e.getElement();[n,d].forEach(r=>{r&&(r.style.transition="opacity 1s",r.style.opacity="1")}),setTimeout(()=>{[n,d].forEach(r=>{r&&(r.style.opacity="0")}),setTimeout(()=>{var r;(r=o.value)==null||r.removeLayer(t)},1e3)},1500)}catch(t){console.error(t),O({message:"Failed to set default map position",variant:"error"})}},Ue=async()=>{if(!v.value||!o.value)return;T.value&&(o.value.removeLayer(T.value),T.value=void 0),T.value=i.marker(v.value,{icon:i.divIcon({className:"marker-icon",iconSize:[24,24],iconAnchor:[12,12]})}).addTo(o.value);const e=i.tooltip({content:'<i class="mdi mdi-crosshairs-gps border-[1px] rounded-full text-[18px] px-[2px] pt-[1px] "></i>',permanent:!0,direction:"center",className:"waypoint-tooltip",opacity:1});if(T.value.bindTooltip(e),R=!1,v.value){const r=s.coordinates.altitude??0,k=v.value[0],F=v.value[1];try{await s.goTo(0,0,0,0,k,F,r),R=!0}catch(Z){O({message:`GoTo request failed: ${Z.message}`,variant:"error"})}}},W=async e=>{switch(e){case"goto":{Ue();break}case"set-default-map-position":We();break;case"place-poi":v.value&&P.value?P.value.openDialog(v.value):v.value?P.value||(O({message:"POI Manager (map widget) is not available.",variant:"error"}),console.error("Cannot open POI dialog, POI Manager (map widget) ref is not set.")):(O({message:"Cannot place Point of Interest without map coordinates.",variant:"error"}),console.error("Cannot open POI dialog without click coordinates for new POI"));break;case"set-home-waypoint":v.value&&ae(v.value);break;default:console.warn("Unknown menu option selected:",e)}M.value=!1};u(pt,(e,t)=>{t&&!e&&(!R&&T.value&&o.value&&(o.value.removeLayer(T.value),T.value=void 0),R=!1)});const U=()=>{M.value=!1,o.value!==void 0&&Me.value!==void 0&&o.value.removeLayer(Me.value)},Te=e=>{e.key==="Escape"&&U()},oe=e=>{e.forEach((t,a)=>{a===0?(h.value=t.coordinates,ae(t.coordinates)):J.value.push(t)})},G=l(!1),Ce=l(0),Le=async()=>{G.value=!0,xe();const e=async t=>{Ce.value=t};try{const t=await s.fetchMission(e);oe(t),O({variant:"success",message:"Mission download succeeded!",duration:3e3})}catch(t){Ne({variant:"error",title:"Mission download failed",message:t,timer:5e3})}finally{G.value=!1}},ae=async e=>{const t=[e[0],e[1]];h.value=t,await s.setHomeWaypoint(t,0),M.value&&(M.value=!1)},Ge=async()=>{try{await s.startMission()}catch{O({message:"Failed to start mission.",variant:"error"})}},_=ft(),Ze=w(()=>`${Math.max(-_.widgetClearanceForVisibleArea(x.value).bottom,0)}px`),Ee=w(()=>`${Math.max(-_.widgetClearanceForVisibleArea(x.value).top,0)}px`),je=w(()=>s.isVehicleOnline?"Download the mission that is stored in the vehicle.":"Cannot download mission (vehicle offline)."),Ye=w(()=>s.isVehicleOnline?"Execute the mission that is stored in the vehicle.":"Cannot execute mission (vehicle offline)."),qe=w(()=>h.value===void 0?"Cannot center map on home (home position undefined).":H.value===m.HOME?"Tracking home position. Click to stop tracking.":"Click once to center on home or twice to track it."),Je=w(()=>s.isVehicleOnline?f.value===void 0?"Cannot center map on vehicle (vehicle position undefined).":H.value===m.VEHICLE?"Tracking vehicle position. Click to stop tracking.":"Click once to center on vehicle or twice to track it.":"Cannot center map on vehicle (vehicle offline)."),Ve=e=>({html:`
    <div class="poi-marker-container">
      <div class="poi-marker-background" style="background-color: ${e.color}80;"></div>
      <i class="v-icon notranslate mdi ${e.icon}" style="color: rgba(255, 255, 255, 0.7); position: relative; z-index: 2;"></i>
    </div>
  `,className:"poi-marker-icon-widget",iconSize:[32,32],iconAnchor:[16,32]}),Ie=e=>{if(!o.value||!o.value.getContainer())return;const t=i.divIcon(Ve(e)),a=i.marker(e.coordinates,{icon:t,draggable:!0}).addTo(o.value),n=`
    <strong>${e.name}</strong><br>
    ${e.description?e.description+"<br>":""}
    Lat: ${e.coordinates[0].toFixed(8)}, Lng: ${e.coordinates[1].toFixed(8)}
  `,d={permanent:!1,direction:"top",offset:[-14,-64],className:"poi-tooltip-widget"};a.bindTooltip(n,d),a.on("drag",r=>{var Z;const k=r.target.getLatLng(),F=`
      <strong>${e.name}</strong><br>
      ${e.description?e.description+"<br>":""}
      Lat: ${k.lat.toFixed(8)}, Lng: ${k.lng.toFixed(8)}
    `;(Z=a.getTooltip())==null||Z.setContent(F)}),a.on("dragend",r=>{const k=r.target.getLatLng();g.movePointOfInterest(e.id,[k.lat,k.lng])}),a.on("click",r=>{if(i.DomEvent.stopPropagation(r),P.value){const k=g.pointsOfInterest.find(F=>F.id===e.id);k?P.value.openDialog(void 0,k):console.warn("POI not found in store:",e.id)}}),y.value[e.id]=a},Oe=e=>{var n;if(!o.value||!o.value.getContainer()||!y.value[e.id])return;const t=y.value[e.id];t.setLatLng(e.coordinates),t.setIcon(i.divIcon(Ve(e)));const a=`
    <strong>${e.name}</strong><br>
    ${e.description?e.description+"<br>":""}
    Lat: ${e.coordinates[0].toFixed(8)}, Lng: ${e.coordinates[1].toFixed(8)}
  `;(n=t.getTooltip())==null||n.setContent(a)},Ke=e=>{!o.value||!y.value[e]||(y.value[e].remove(),delete y.value[e])};return u(()=>g.pointsOfInterest,async e=>{if((!o.value||!o.value.getContainer())&&(await gt(),!o.value||!o.value.getContainer())){console.warn("Map.vue: POI watcher - map not ready after nextTick.");return}const t=new Set(e.map(a=>a.id));Object.keys(y.value).forEach(a=>{t.has(a)||Ke(a)}),e.forEach(a=>{y.value[a.id]?Oe(a):Ie(a)})},{deep:!0,immediate:!0}),u(o,e=>{e&&e.getContainer()&&g.pointsOfInterest.forEach(t=>{y.value[t.id]?Oe(t):Ie(t)})},{immediate:!0}),(e,t)=>{const a=ht("contextmenu");return L(),ne(Ot,null,[yt((L(),ne("div",{ref_key:"mapBase",ref:$,class:bt(["page-base",c(_).editingMode?"pointer-events-none":"pointer-events-auto"])},[xt("div",{id:le.value,ref_key:"map",ref:o,class:"map"},[b(q,{location:"top",text:qe.value},{activator:E(({props:n})=>[V.value?(L(),D(j,Y({key:0},n,{class:["absolute right-[166px] m-3 bottom-button bg-slate-50 text-[14px]",h.value?"":"active-events-on-disabled"],color:H.value==c(m).HOME?"red":"",elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-home-search",size:"x-small",disabled:!h.value,onClick:t[0]||(t[0]=A(d=>c(p).goToTarget(c(m).HOME,!0),["stop"])),onDblclick:t[1]||(t[1]=A(d=>c(p).follow(c(m).HOME),["stop"]))}),null,16,["class","color","disabled"])):z("",!0)]),_:1},8,["text"]),b(q,{location:"top",text:Je.value},{activator:E(({props:n})=>[V.value?(L(),D(j,Y({key:0},n,{class:["absolute m-3 bottom-button right-[124px] bg-slate-50 text-[14px]",f.value?"":"active-events-on-disabled"],color:H.value==c(m).VEHICLE?"red":"",elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-airplane-marker",size:"x-small",disabled:!f.value,onClick:t[2]||(t[2]=A(d=>c(p).goToTarget(c(m).VEHICLE,!0),["stop"])),onDblclick:t[3]||(t[3]=A(d=>c(p).follow(c(m).VEHICLE),["stop"]))}),null,16,["class","color","disabled"])):z("",!0)]),_:1},8,["text"]),b(q,{location:"top",text:je.value},{activator:E(({props:n})=>[V.value?(L(),D(j,Y({key:0},n,{class:["absolute m-3 bottom-button right-[82px] bg-slate-50 text-[14px]",c(s).isVehicleOnline?"":"active-events-on-disabled"],disabled:!c(s).isVehicleOnline,elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-download",size:"x-small",onClick:A(Le,["stop"])}),null,16,["class","disabled"])):z("",!0)]),_:1},8,["text"]),b(q,{location:"top",text:Ye.value},{activator:E(({props:n})=>[V.value?(L(),D(j,Y({key:0},n,{class:["absolute mb-3 ml-1 bottom-button right-[52px] bg-slate-50 text-[14px]",c(s).isVehicleOnline?"":"active-events-on-disabled"],disabled:!c(s).isVehicleOnline,elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-play",size:"x-small",onClick:A(Ge,["stop"])}),null,16,["class","disabled"])):z("",!0)]),_:1},8,["text"])],8,At)],2)),[[a,De]]),b(kt,{ref_key:"contextMenuRef",ref:ce,visible:M.value,width:"260px","menu-items":Re,onClose:U},null,8,["visible","menu-items"]),b(Et,{modelValue:c(_).widgetManagerVars(c(x).hash).configMenuOpen,"onUpdate:modelValue":t[5]||(t[5]=n=>c(_).widgetManagerVars(c(x).hash).configMenuOpen=n),width:"auto"},{default:E(()=>[b(wt,{class:"pa-2",style:ie(c(ze).globalGlassMenuStyles)},{default:E(()=>[b(Mt,{class:"text-center"},{default:E(()=>t[6]||(t[6]=[Tt("Map widget settings")])),_:1}),b(Ct,null,{default:E(()=>[b(Lt,{modelValue:c(x).options.showVehiclePath,"onUpdate:modelValue":t[4]||(t[4]=n=>c(x).options.showVehiclePath=n),class:"my-1",label:"Show vehicle path",color:c(x).options.showVehiclePath?"white":void 0,"hide-details":""},null,8,["modelValue","color"])]),_:1})]),_:1},8,["style"])]),_:1},8,["modelValue"]),G.value?(L(),D(Vt,{key:0,"model-value":Ce.value,height:"10",absolute:"",bottom:"",color:"white",style:ie(`top: ${Ee.value}`)},null,8,["model-value","style"])):z("",!0),G.value?(L(),ne("p",{key:1,style:ie({top:Ee.value}),class:"absolute left-[7px] mt-4 flex text-md font-bold text-white z-30 drop-shadow-md"}," Loading mission... ",4)):z("",!0),b(It,{ref_key:"poiManagerMapWidgetRef",ref:P},null,512)],64)}}}),_t=Ht(zt,[["__scopeId","data-v-972fca19"]]);export{_t as default};
