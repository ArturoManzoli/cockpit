import{c as ee,a8 as te,K as ae,y as ne,a9 as se,J as oe,r as m,aa as ie,ab as re,e as le,k as M,w as v,o as de,L as ue,ac as ce,ad as me,ae as ve,D as fe,l as i,m as u,n as f,v as L,q as r,H as x,N as g,Q as b,af as F,F as q,t as z,I as C,s as H,ag as ge,ah as pe,O as ye,ai as xe,a6 as G,W as he,aj as Se,_ as we}from"./index-g0toarpg.js";const be={key:1},ke={class:"text-xs text-white select-none scroll-text"},Ve={key:3,class:"w-13 text-justify text-slate-100"},Me={key:0,class:"text-justify text-slate-100 text-xs -ml-2"},Fe={key:1,class:"-ml-1"},Ce={key:4,class:"w-16 text-justify text-slate-100"},Re={class:"flex justify-center w-6"},Ie={class:"flex w-full justify-between items-center mt-4"},Ne={key:1,class:"w-5 h-5 ml-2 rounded-full bg-red"},_e=ee({__name:"MiniVideoRecorder",props:{miniWidget:{}},setup(J){const{showDialog:h}=te(),_=ae(),p=ne(),n=se(),s=oe(J).miniWidget,a=m(),{namessAvailableAbstractedStreams:k}=ie(n),O=m(),{isOutside:W}=re(O),D=m(!1),S=m(!1),K=le({interval:100}),c=m(),w=m(!1),R=m(0),o=m(),I=M(()=>o.value),N=()=>{_.videoLibraryVisibility=!0};v(()=>n.streamsCorrespondency,()=>c.value=void 0,{deep:!0});const j=M(()=>o.value?n.streamsPreparingToRecord.includes(o.value):!1);de(async()=>{await V()}),ue(async()=>{Object.keys(s.value.options).length===0&&(s.value.options={internalStreamName:void 0}),a.value=s.value.options.internalStreamName,a.value&&(o.value=n.externalStreamId(a.value))}),v(a,()=>{s.value.options.internalStreamName=a.value,c.value=void 0}),v(()=>n.streamsCorrespondency,t=>{if(!o.value)return;const e=t.find(l=>l.externalId===o.value);e?a.value!==e.name&&(a.value=e.name):(a.value=void 0,o.value=void 0)},{deep:!0}),v(a,t=>{o.value=t?n.externalStreamId(t):void 0,s.value.options.internalStreamName=t,c.value=void 0});const V=async()=>{const e=(await n.videoStorage.keys()).filter(d=>n.isVideoFilename(d)).length,l=Object.keys(n.keysFailedUnprocessedVideos).length;R.value=e+l};function T(t){if(a.value=t,a.value===void 0){h({message:"No stream selected.",variant:"error"});return}if(k.value.includes(a.value))return;const e="The selected stream is not available. Please check its source or select another stream.";throw h({message:e,variant:"error"}),new Error(e)}const Q=async()=>{if(y.value){o.value&&n.stopRecording(o.value);return}if(!a.value){p.miniWidgetManagerVars(s.value.hash).configMenuOpen=!0;return}B()},B=()=>{var t;if(!o.value){h({title:"Cannot start recording.",message:"No stream selected.",variant:"error"});return}if(!((t=n.getStreamData(o.value))!=null&&t.connected)){h({title:"Cannot start recording.",message:"Stream is not connected.",variant:"error"});return}T(a.value),n.startRecording(o.value),p.miniWidgetManagerVars(s.value.hash).configMenuOpen=!1},y=M(()=>o.value?n.isRecording(o.value):!1),Y=M(()=>{var $,A,E,U;if(I.value===void 0)return"00:00:00";const t=($=n.getStreamData(I.value))==null?void 0:$.timeRecordingStart;if(t===void 0)return"00:00:00";const e=ce({start:t,end:K.value}),l=((A=e.hours)==null?void 0:A.toFixed(0).length)===1?`0${e.hours}`:e.hours,d=((E=e.minutes)==null?void 0:E.toFixed(0).length)===1?`0${e.minutes}`:e.minutes,Z=((U=e.seconds)==null?void 0:U.toFixed(0).length)===1?`0${e.seconds}`:e.seconds;return`${l}:${d}:${Z}`}),X=async t=>{T(t),c.value=void 0,S.value=!0;let e=0;const l=100,d=3e3;for(;S.value&&e<d;)S.value=c.value===void 0||!c.value.active,await Se(l),e+=l;if(S.value){h({message:"Could not load media stream.",variant:"error"});return}s.value.options.internalStreamName=t};let P;return p.isRealMiniWidget(s.value.hash)&&(P=setInterval(()=>{if(s.value.options.internalStreamName===void 0&&!k.value.isEmpty()&&(s.value.options.internalStreamName=k.value[0],a.value=s.value.options.internalStreamName),I.value!==void 0){const t=n.getMediaStream(s.value.options.internalStreamName);me(t,c.value)||(c.value=t)}},1e3)),ve(()=>clearInterval(P)),v(()=>n.areThereVideosProcessing,t=>{w.value=t,V()}),v(()=>n.keysFailedUnprocessedVideos,()=>V()),v(()=>D.value,async t=>{t===!1&&await V()}),v(y,()=>{if(!y.value){window.onbeforeunload=null;return}window.onbeforeunload=()=>(h({message:`
      You have a video recording ongoing.
      Remember to stop it before closing Cockpit, or the record will be lost.
    `,variant:"warning"}),"I hope the user does not click on the leave button.")}),(t,e)=>{const l=fe("FontAwesomeIcon");return i(),u(q,null,[f("div",{ref_key:"recorderWidget",ref:O,class:"flex justify-around px-1 py-1 text-center rounded-lg w-40 h-9 align-center bg-slate-800/60"},[w.value?(i(),u("div",be,[x(F,{class:"w-6 h-6 animate-spin",color:"white"},{default:g(()=>e[4]||(e[4]=[b("mdi-loading")])),_:1})])):(i(),u("div",{key:0,class:L([{"blob red w-5 opacity-100 rounded-sm mr-[6px]":y.value||j.value,"opacity-30 bg-red-400":r(W)&&!y.value},"w-6 transition-all duration-500 rounded-full aspect-square bg-red-lighten-1 hover:cursor-pointer opacity-70 hover:opacity-90"]),onClick:e[0]||(e[0]=d=>Q())},null,2)),!y.value&&!w.value?(i(),u(q,{key:2},[a.value?(i(),u("div",{key:0,class:"flex flex-col max-w-[50%] scroll-container transition-all border-blur cursor-pointer",onClick:e[1]||(e[1]=d=>r(p).miniWidgetManagerVars(r(s).hash).configMenuOpen=!0)},[f("div",ke,z(a.value),1)])):(i(),C(l,{key:1,icon:"fa-solid fa-video",class:"h-6 text-slate-100"}))],64)):H("",!0),y.value&&!w.value?(i(),u("div",Ve,[j.value?(i(),u("p",Me,"Starting...")):(i(),u("p",Fe,z(Y.value),1))])):w.value?(i(),u("div",Ce,e[5]||(e[5]=[f("div",{class:"text-xs text-center text-white select-none flex-nowrap"},"Processing video...",-1)]))):H("",!0),f("div",Re,[x(ge,{vertical:"",class:"h-6 ml-1"}),R.value>0?(i(),C(pe,{key:0,color:"info",content:R.value,dot:r(W)||D.value,class:"cursor-pointer",onClick:N},{default:g(()=>[x(F,{class:"w-6 h-6 ml-1 text-slate-100",onClick:N},{default:g(()=>e[6]||(e[6]=[b(" mdi-video-box ")])),_:1})]),_:1},8,["content","dot"])):(i(),C(F,{key:1,class:"w-6 h-6 ml-1 text-slate-100 cursor-pointer",onClick:N},{default:g(()=>e[7]||(e[7]=[b(" mdi-video-box ")])),_:1}))])],512),x(he,{modelValue:r(p).miniWidgetManagerVars(r(s).hash).configMenuOpen,"onUpdate:modelValue":e[3]||(e[3]=d=>r(p).miniWidgetManagerVars(r(s).hash).configMenuOpen=d),width:"auto"},{default:g(()=>[f("div",{class:"flex flex-col items-center p-2 pt-1 m-5 rounded-md gap-y-4",style:ye(r(_).globalGlassMenuStyles)},[e[11]||(e[11]=f("p",{class:"text-xl font-semibold m-4"},"Choose a stream to record",-1)),x(xe,{"model-value":a.value,label:"Stream name",items:r(k),"item-title":"name",density:"compact",variant:"outlined","no-data-text":"No streams available.","hide-details":"","return-object":"",theme:"dark",class:"w-[90%]","onUpdate:modelValue":X},null,8,["model-value","items"]),f("div",Ie,[x(G,{class:"w-auto text-uppercase",variant:"text",onClick:e[2]||(e[2]=d=>r(p).miniWidgetManagerVars(r(s).hash).configMenuOpen=!1)},{default:g(()=>e[8]||(e[8]=[b(" Close ")])),_:1}),x(G,{class:L(["bg-[#FFFFFF11] hover:bg-[#FFFFFF33]",{"opacity-30 pointer-events-none":S.value}]),size:"large",onClick:B},{default:g(()=>[e[10]||(e[10]=f("span",null,"Record",-1)),S.value?(i(),C(F,{key:0,class:"m-2 animate-spin"},{default:g(()=>e[9]||(e[9]=[b("mdi-loading")])),_:1})):(i(),u("div",Ne))]),_:1},8,["class"])])],4)]),_:1},8,["modelValue"])],64)}}}),De=we(_e,[["__scopeId","data-v-329dcd26"]]);export{De as default};
