import{c as Ge,bv as Re,J as Ze,K as We,a8 as Ye,u as Ke,ak as je,r,k as b,M as Te,Y as Ce,L as qe,bF as l,j as Je,w as c,o as Qe,bG as v,ae as Xe,bH as et,aI as tt,bI as ot,bJ as at,bK as Ve,aF as nt,bL as it,bM as P,y as lt,be as st,l as T,m as X,G as rt,v as ut,q as s,n as ct,H as x,N as C,I as N,a6 as F,a0 as U,au as O,s as H,a1 as G,bN as dt,V as vt,O as ee,P as mt,Q as pt,R as ft,a5 as gt,W as ht,bO as yt,F as bt,bP as xt,bQ as kt,bR as wt,z as Mt,B as Tt,E as Ct,_ as Vt}from"./index-C6MTcsjG.js";const Et=["id"],Lt=Ge({__name:"Map",props:{widget:{}},setup(Ee){var Me;Re(e=>({"3927adff":Be.value}));const te=Ee,h=Ze(te).widget,Le=We(),{showDialog:Se}=Ye(),n=Ke(),w=je(),o=r(),A=r(w.defaultMapZoom),L=r(w.defaultMapCenter),f=r(),oe=b(()=>`map-${h.value.hash}`),V=r(!1),ae=r(!1),R=r([]),ne=r(),Z=r(!1),W=r(!1);let ie;const le=e=>{e.touches.length>1&&(W.value=!0,k.value&&$(),clearTimeout(ie))},se=e=>{e.touches.length<=1&&(ie=window.setTimeout(()=>W.value=!1,300))};Te.registerUsage(Ce.latitude),Te.registerUsage(Ce.longitude),qe(()=>{Object.keys(h.value.options).length===0&&(h.value.options={showVehiclePath:!0}),m.enableAutoUpdate()});const re=l.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:23,maxNativeZoom:19,attribution:"© OpenStreetMap"}),ue=l.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{maxZoom:23,maxNativeZoom:19,attribution:"© Esri World Imagery"}),ce=l.tileLayer("https://tiles.openseamap.org/seamark/{z}/{x}/{y}.png",{maxZoom:18,attribution:"© OpenSeaMap contributors"}),de=l.tileLayer.wms("https://geoserver.openseamap.org/geoserver/gwc/service/wms",{layers:"gebco2021:gebco_2021",format:"image/png",transparent:!0,version:"1.1.1",attribution:"© GEBCO, OpenSeaMap",tileSize:256,maxZoom:19}),Ie={OpenStreetMap:re,"Esri World Imagery":ue},Oe={Seamarks:ce,"Marine Profile":de},S=r(),ve=Je(S),me=l.control.zoom({position:"bottomright"}),pe=l.control.layers(Ie,Oe);c(V,()=>{o.value!==void 0&&(V.value?(o.value.addControl(me),o.value.addControl(pe)):(o.value.removeControl(me),o.value.removeControl(pe)))}),c(ve,()=>{V.value=ve.value}),Qe(async()=>{var e,t;h.value.options.blockGenericContextMenu=!0,(e=S.value)==null||e.addEventListener("touchstart",le,{passive:!0}),(t=S.value)==null||t.addEventListener("touchend",se,{passive:!0}),o.value=l.map(oe.value,{layers:[re,ue,ce,de],attributionControl:!1}).setView(L.value,A.value),o.value.removeControl(o.value.zoomControl),o.value.on("click",a=>{y.value=[a.latlng.lat,a.latlng.lng]}),o.value.on("moveend",()=>{if(o.value===void 0)return;let{lat:a,lng:i}=o.value.getCenter();a&&i&&(L.value=[a,i])}),o.value.on("dragstart",()=>{Z.value=!0}),o.value.on("dragend",()=>{setTimeout(()=>Z.value=!1,200)}),o.value.on("zoomend",()=>{var a;k.value=!1,o.value!==void 0&&(A.value=((a=o.value)==null?void 0:a.getZoom())??L.value)}),o.value.on("contextmenu",a=>{y.value=[a.latlng.lat,a.latlng.lng]}),m.enableAutoUpdate(),window.addEventListener("keydown",be),p.value?m.goToTarget(v.VEHICLE):m.goToTarget(v.HOME),!n.isVehicleOnline&&w.vehicleMission.length&&J(w.vehicleMission),ae.value=!0,await Y()});const He={open:e=>{if(!o.value||W.value||Z.value)return;e.preventDefault(),e.stopPropagation();const t=o.value.mouseEventToContainerPoint(e),a=o.value.containerPointToLatLng(t);y.value=[a.lat,a.lng],ne.value.openAt(e),k.value=!0},close:()=>{$()}},fe=()=>{var e;(e=o.value)==null||e.eachLayer(t=>{(t instanceof l.Marker||t instanceof l.Polyline&&t.options.color==="#358AC3")&&o.value.removeLayer(t)}),R.value=[],_.value=void 0,E.value=void 0,g.value=void 0},Y=async()=>{ae.value&&(fe(),n.isVehicleOnline?await ke():w.vehicleMission.length&&J(w.vehicleMission))};c(()=>n.isVehicleOnline,()=>{Y()}),c(()=>w.vehicleMissionRevision,()=>{Y()}),Xe(()=>{var e,t;m.disableAutoUpdate(),window.removeEventListener("keydown",be),(e=S.value)==null||e.removeEventListener("touchstart",le),(t=S.value)==null||t.removeEventListener("touchend",se)}),c(L,(e,t)=>{var a;e.toString()!==t.toString()&&((a=o.value)==null||a.panTo(e))}),c(o,(e,t)=>{o.value!==void 0&&(e==null?void 0:e.options)===void 0&&(o.value=t)}),c(A,(e,t)=>{var a;e!==t&&(k.value=!1,(a=o.value)==null||a.setZoom(A.value))}),c(te.widget,()=>{var e;(e=o.value)==null||e.invalidateSize()});const I=r(void 0),m=new et(e=>I.value=e,e=>L.value=e);m.setTrackableTarget(v.VEHICLE,()=>p.value),m.setTrackableTarget(v.HOME,()=>f.value);const p=b(()=>n.coordinates.latitude?[n.coordinates.latitude,n.coordinates.longitude]:void 0),K=b(()=>{var e;return n.attitude.yaw?tt((e=n.attitude)==null?void 0:e.yaw):0}),ge=b(()=>{const e=n.lastHeartbeat;return e?`${ot(e??0,{includeSeconds:!0})} ago`:"never"}),{history:Ae}=at(p);(Me=navigator==null?void 0:navigator.geolocation)==null||Me.watchPosition(e=>{f.value||(f.value=[e.coords.latitude,e.coords.longitude])},e=>console.error(`Failed to get position: (${e.code}) ${e.message}`),{enableHighAccuracy:!1,timeout:5e3,maximumAge:0});let he=!0;c([f,o],async()=>{f.value===L.value||!o.value||!he||(m.goToTarget(v.HOME),he=!1)});const M=r();c(n.coordinates,()=>{if(!(!o.value||!p.value)){if(M.value===void 0){let e=xt;n.vehicleType===Ve.MAV_TYPE_SURFACE_BOAT?e=kt:n.vehicleType===Ve.MAV_TYPE_SUBMARINE&&(e=wt);const t=l.divIcon({className:"vehicle-marker",html:`<img src="${e}" style="width: 64px; height: 64px;">`,iconSize:[64,64],iconAnchor:[32,32]});M.value=l.marker(p.value,{icon:t});const a=l.tooltip({content:"No data available",className:"waypoint-tooltip",offset:[40,0]});M.value.bindTooltip(a),o.value.addLayer(M.value)}M.value.setLatLng(p.value)}}),c(p,(e,t)=>{I.value===v.VEHICLE||t!==void 0||m.follow(v.VEHICLE)}),c([p,K,ge,()=>n.isArmed],()=>{var t,a,i,u,d;if(M.value===void 0)return;(u=M.value.getTooltip())==null||u.setContent(`
    <p>Coordinates: ${(t=p.value)==null?void 0:t[0].toFixed(6)}, ${(a=p.value)==null?void 0:a[1].toFixed(6)}</p>
    <p>Velocity: ${((i=n.velocity.ground)==null?void 0:i.toFixed(2))??"N/A"} m/s</p>
    <p>Heading: ${K.value.toFixed(2)}°</p>
    <p>${n.isArmed?"Armed":"Disarmed"}</p>
    <p>Last seen: ${ge.value}</p>
  `);const e=(d=M.value.getElement())==null?void 0:d.querySelector("img");e&&(e.style.transform=`rotate(${K.value}deg)`)});const E=r();c(f,()=>{if(o.value===void 0)return;const e=f.value;if(e!==void 0)if(E.value)E.value.setLatLng(e);else{E.value=l.marker(e,{icon:l.divIcon({className:"marker-icon",iconSize:[24,24],iconAnchor:[12,12]}),draggable:!0});const t=l.tooltip({content:'<i class="mdi mdi-home-map-marker text-[18px] "></i>',permanent:!0,direction:"center",className:"waypoint-tooltip",opacity:1});E.value.bindTooltip(t),E.value.on("dragend",a=>{const u=a.target.getLatLng();Q([u.lat,u.lng])}),o.value.addLayer(E.value)}});const _=r();c(R,e=>{o.value&&(_.value||(_.value=l.polyline([],{color:"#358AC3"}).addTo(o.value)),_.value.setLatLngs(e.map(t=>t.coordinates)),e.forEach((t,a)=>{var d;const i=l.marker(t.coordinates);i.setIcon(l.divIcon({className:"marker-icon",iconSize:[16,16],iconAnchor:[8,8]}));const u=l.tooltip({content:a.toString(),permanent:!0,direction:"center",className:"waypoint-tooltip",opacity:1});i.bindTooltip(u),(d=o.value)==null||d.addLayer(i)}))},{deep:!0});const j=r();c(Ae,e=>{if(o.value===void 0||e===void 0)return;j.value===void 0&&(j.value=l.polyline([],{color:"#ffff00"}).addTo(o.value));const t=e.filter(a=>a.snapshot!==void 0).map(a=>a.snapshot);j.value.setLatLngs(t)});const k=r(!1),y=r(null),ye=r(),ze=nt([{item:"Set home waypoint",action:()=>q("set-home-waypoint"),icon:"mdi-home-map-marker"},{item:"GoTo",action:()=>q("goto"),icon:"mdi-crosshairs-gps"},{item:"Set default map position",action:()=>q("set-default-map-position"),icon:"mdi-map-check"}]),g=r();let B=!1;const Pe=async()=>{var e;if(!(!o.value||!y.value))try{await w.setDefaultMapPosition(y.value,A.value),P({message:"Default map position set",variant:"success"});const t=l.marker(y.value,{icon:l.divIcon({className:"marker-icon",iconSize:[24,24],iconAnchor:[12,12]})}).addTo(o.value),a=l.tooltip({content:'<i class="mdi mdi-map-check text-[18px] border-[1px] rounded-full px-[2px] py-[1px]"></i>',permanent:!0,direction:"center",className:"waypoint-tooltip",opacity:1});t.bindTooltip(a).openTooltip();const i=t.getElement(),u=(e=t.getTooltip())==null?void 0:e.getElement();[i,u].forEach(d=>{d&&(d.style.transition="opacity 1s",d.style.opacity="1")}),setTimeout(()=>{[i,u].forEach(d=>{d&&(d.style.opacity="0")}),setTimeout(()=>{var d;(d=o.value)==null||d.removeLayer(t)},1e3)},1500)}catch(t){console.error(t),P({message:"Failed to set default map position",variant:"error"})}},Ne=()=>{if(!y.value||!o.value)return;g.value&&(o.value.removeLayer(g.value),g.value=void 0),g.value=l.marker(y.value,{icon:l.divIcon({className:"marker-icon",iconSize:[24,24],iconAnchor:[12,12]})}).addTo(o.value);const e=l.tooltip({content:'<i class="mdi mdi-crosshairs-gps border-[1px] rounded-full text-[18px] px-[2px] pt-[1px] "></i>',permanent:!0,direction:"center",className:"waypoint-tooltip",opacity:1});g.value.bindTooltip(e),B=!1,Promise.resolve(Mt(async()=>{B=!0;const[t,a]=y.value,i=n.coordinates.altitude??0;try{await n.goTo(0,0,0,0,t,a,i)}catch(u){P({message:`${u}`,variant:"error"})}},{command:"GoTo"},Tt(Ct.GOTO))).catch(()=>{g.value&&o.value&&(o.value.removeLayer(g.value),g.value=void 0)})},q=e=>{switch(e){case"goto":{Ne();break}case"set-default-map-position":Pe();break;case"set-home-waypoint":y.value&&Q(y.value);break;default:console.warn("Unknown menu option selected:",e)}k.value=!1};c(it,(e,t)=>{t&&!e&&(!B&&g.value&&o.value&&(o.value.removeLayer(g.value),g.value=void 0),B=!1)});const $=()=>{k.value=!1,o.value!==void 0&&ye.value!==void 0&&o.value.removeLayer(ye.value)},be=e=>{e.key==="Escape"&&$()},J=e=>{e.forEach((t,a)=>{a===0?(f.value=t.coordinates,Q(t.coordinates)):R.value.push(t)})},D=r(!1),xe=r(0),ke=async()=>{D.value=!0,fe();const e=async t=>{xe.value=t};try{const t=await n.fetchMission(e);J(t),P({variant:"success",message:"Mission download succeeded!",duration:3e3})}catch(t){Se({variant:"error",title:"Mission download failed",message:t,timer:5e3})}finally{D.value=!1}},Q=async e=>{const t=[e[0],e[1]];f.value=t,await n.setHomeWaypoint(t,0),k.value&&(k.value=!1)},_e=async()=>{try{await n.startMission()}catch{P({message:"Failed to start mission.",variant:"error"})}},z=lt(),Be=b(()=>`${Math.max(-z.widgetClearanceForVisibleArea(h.value).bottom,0)}px`),we=b(()=>`${Math.max(-z.widgetClearanceForVisibleArea(h.value).top,0)}px`),$e=b(()=>n.isVehicleOnline?"Download the mission that is stored in the vehicle.":"Cannot download mission (vehicle offline)."),De=b(()=>n.isVehicleOnline?"Execute the mission that is stored in the vehicle.":"Cannot execute mission (vehicle offline)."),Fe=b(()=>f.value===void 0?"Cannot center map on home (home position undefined).":I.value===v.HOME?"Tracking home position. Click to stop tracking.":"Click once to center on home or twice to track it."),Ue=b(()=>n.isVehicleOnline?p.value===void 0?"Cannot center map on vehicle (vehicle position undefined).":I.value===v.VEHICLE?"Tracking vehicle position. Click to stop tracking.":"Click once to center on vehicle or twice to track it.":"Cannot center map on vehicle (vehicle offline).");return(e,t)=>{const a=st("contextmenu");return T(),X(bt,null,[rt((T(),X("div",{ref_key:"mapBase",ref:S,class:ut(["page-base",s(z).editingMode?"pointer-events-none":"pointer-events-auto"])},[ct("div",{id:oe.value,ref_key:"map",ref:o,class:"map"},[x(G,{location:"top",text:Fe.value},{activator:C(({props:i})=>[V.value?(T(),N(F,U({key:0},i,{class:["absolute right-[166px] m-3 bottom-button bg-slate-50 text-[14px]",f.value?"":"active-events-on-disabled"],color:I.value==s(v).HOME?"red":"",elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-home-search",size:"x-small",disabled:!f.value,onClick:t[0]||(t[0]=O(u=>s(m).goToTarget(s(v).HOME,!0),["stop"])),onDblclick:t[1]||(t[1]=O(u=>s(m).follow(s(v).HOME),["stop"]))}),null,16,["class","color","disabled"])):H("",!0)]),_:1},8,["text"]),x(G,{location:"top",text:Ue.value},{activator:C(({props:i})=>[V.value?(T(),N(F,U({key:0},i,{class:["absolute m-3 bottom-button right-[124px] bg-slate-50 text-[14px]",p.value?"":"active-events-on-disabled"],color:I.value==s(v).VEHICLE?"red":"",elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-airplane-marker",size:"x-small",disabled:!p.value,onClick:t[2]||(t[2]=O(u=>s(m).goToTarget(s(v).VEHICLE,!0),["stop"])),onDblclick:t[3]||(t[3]=O(u=>s(m).follow(s(v).VEHICLE),["stop"]))}),null,16,["class","color","disabled"])):H("",!0)]),_:1},8,["text"]),x(G,{location:"top",text:$e.value},{activator:C(({props:i})=>[V.value?(T(),N(F,U({key:0},i,{class:["absolute m-3 bottom-button right-[82px] bg-slate-50 text-[14px]",s(n).isVehicleOnline?"":"active-events-on-disabled"],disabled:!s(n).isVehicleOnline,elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-download",size:"x-small",onClick:O(ke,["stop"])}),null,16,["class","disabled"])):H("",!0)]),_:1},8,["text"]),x(G,{location:"top",text:De.value},{activator:C(({props:i})=>[V.value?(T(),N(F,U({key:0},i,{class:["absolute mb-3 ml-1 bottom-button right-[52px] bg-slate-50 text-[14px]",s(n).isVehicleOnline?"":"active-events-on-disabled"],disabled:!s(n).isVehicleOnline,elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-play",size:"x-small",onClick:O(_e,["stop"])}),null,16,["class","disabled"])):H("",!0)]),_:1},8,["text"])],8,Et)],2)),[[a,He]]),x(dt,{ref_key:"contextMenuRef",ref:ne,visible:k.value,width:"260px","menu-items":ze,onClose:$},null,8,["visible","menu-items"]),x(ht,{modelValue:s(z).widgetManagerVars(s(h).hash).configMenuOpen,"onUpdate:modelValue":t[5]||(t[5]=i=>s(z).widgetManagerVars(s(h).hash).configMenuOpen=i),width:"auto"},{default:C(()=>[x(vt,{class:"pa-2",style:ee(s(Le).globalGlassMenuStyles)},{default:C(()=>[x(mt,{class:"text-center"},{default:C(()=>t[6]||(t[6]=[pt("Map widget settings")])),_:1}),x(ft,null,{default:C(()=>[x(gt,{modelValue:s(h).options.showVehiclePath,"onUpdate:modelValue":t[4]||(t[4]=i=>s(h).options.showVehiclePath=i),class:"my-1",label:"Show vehicle path",color:s(h).options.showVehiclePath?"white":void 0,"hide-details":""},null,8,["modelValue","color"])]),_:1})]),_:1},8,["style"])]),_:1},8,["modelValue"]),D.value?(T(),N(yt,{key:0,"model-value":xe.value,height:"10",absolute:"",bottom:"",color:"white",style:ee(`top: ${we.value}`)},null,8,["model-value","style"])):H("",!0),D.value?(T(),X("p",{key:1,style:ee({top:we.value}),class:"absolute left-[7px] mt-4 flex text-md font-bold text-white z-30 drop-shadow-md"}," Loading mission... ",4)):H("",!0)],64)}}}),It=Vt(Lt,[["__scopeId","data-v-f1cb2cda"]]);export{It as default};
