import{bF as Se,bG as Xe,bH as Ge,bI as K,f as We,bJ as Te,bK as Ze,bL as Ye,c as qe,bv as Ke,J as je,K as Je,a8 as Qe,u as et,ak as tt,r as d,k as C,M as ke,Y as Ce,L as at,bM as s,j as ot,w as p,o as nt,bN as h,ae as it,bO as st,aI as lt,bP as rt,bQ as Ve,aF as ct,bR as ut,bS as R,y as dt,be as vt,l as O,m as re,G as mt,v as ft,q as u,n as pt,H as V,N as D,I as X,a6 as j,a0 as J,au as z,s as P,a1 as Q,bT as gt,V as ht,O as ce,P as yt,Q as bt,R as xt,a5 as Mt,W as wt,bU as Tt,F as kt,z as Ct,B as Vt,E as Et,_ as St}from"./index-DcSWdQ69.js";function Ie(y,M){if(y==null)throw new TypeError("assign requires that input parameter not be null or undefined");for(var l in M)Object.prototype.hasOwnProperty.call(M,l)&&(y[l]=M[l]);return y}function It(y){return Ie({},y)}var Ee=1440,Lt=2520,ue=43200,Ot=86400;function Dt(y,M,l){var $,B;Se(2,arguments);var o=Ye(),i=($=(B=l==null?void 0:l.locale)!==null&&B!==void 0?B:o.locale)!==null&&$!==void 0?$:Xe;if(!i.formatDistance)throw new RangeError("locale must contain formatDistance property");var a=Ge(y,M);if(isNaN(a))throw new RangeError("Invalid time value");var r=Ie(It(l),{addSuffix:!!(l!=null&&l.addSuffix),comparison:a}),w,v;a>0?(w=K(M),v=K(y)):(w=K(y),v=K(M));var E=We(v,w),S=(Te(v)-Te(w))/1e3,m=Math.round((E-S)/60),k;if(m<2)return l!=null&&l.includeSeconds?E<5?i.formatDistance("lessThanXSeconds",5,r):E<10?i.formatDistance("lessThanXSeconds",10,r):E<20?i.formatDistance("lessThanXSeconds",20,r):E<40?i.formatDistance("halfAMinute",0,r):E<60?i.formatDistance("lessThanXMinutes",1,r):i.formatDistance("xMinutes",1,r):m===0?i.formatDistance("lessThanXMinutes",1,r):i.formatDistance("xMinutes",m,r);if(m<45)return i.formatDistance("xMinutes",m,r);if(m<90)return i.formatDistance("aboutXHours",1,r);if(m<Ee){var G=Math.round(m/60);return i.formatDistance("aboutXHours",G,r)}else{if(m<Lt)return i.formatDistance("xDays",1,r);if(m<ue){var W=Math.round(m/Ee);return i.formatDistance("xDays",W,r)}else if(m<Ot)return k=Math.round(m/ue),i.formatDistance("aboutXMonths",k,r)}if(k=Ze(v,w),k<12){var Z=Math.round(m/ue);return i.formatDistance("xMonths",Z,r)}else{var F=k%12,H=Math.floor(k/12);return F<3?i.formatDistance("aboutXYears",H,r):F<9?i.formatDistance("overXYears",H,r):i.formatDistance("almostXYears",H+1,r)}}function Ht(y,M){return Se(1,arguments),Dt(y,Date.now(),M)}const _t=""+new URL("blueboat-marker-DyHmCFOq.png",import.meta.url).href,Nt=""+new URL("brov2-marker-CBzp11FX.png",import.meta.url).href,At=""+new URL("generic-vehicle-marker-SovxT5Tc.png",import.meta.url).href,zt=["id"],Pt=qe({__name:"Map",props:{widget:{}},setup(y){var we;Ke(e=>({"7cd608b6":$e.value}));const M=y,l=je(M).widget,$=Je(),{showDialog:B}=Qe(),o=et(),i=tt(),a=d(),r=d(i.defaultMapZoom),w=d(i.defaultMapCenter),v=d(),E=C(()=>`map-${l.value.hash}`),S=d(!1),m=d(!1),k=d([]),G=d();ke.registerUsage(Ce.latitude),ke.registerUsage(Ce.longitude),at(()=>{Object.keys(l.value.options).length===0&&(l.value.options={showVehiclePath:!0}),b.enableAutoUpdate()});const W=s.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{maxZoom:23,maxNativeZoom:19,attribution:"© OpenStreetMap"}),Z=s.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{maxZoom:23,maxNativeZoom:19,attribution:"© Esri World Imagery"}),F=s.tileLayer("https://tiles.openseamap.org/seamark/{z}/{x}/{y}.png",{maxZoom:18,attribution:"© OpenSeaMap contributors"}),H=s.tileLayer.wms("https://geoserver.openseamap.org/geoserver/gwc/service/wms",{layers:"gebco2021:gebco_2021",format:"image/png",transparent:!0,version:"1.1.1",attribution:"© GEBCO, OpenSeaMap",tileSize:256,maxZoom:19}),Le={OpenStreetMap:W,"Esri World Imagery":Z},Oe={Seamarks:F,"Marine Profile":H},de=d(),ve=ot(de),me=s.control.zoom({position:"bottomright"}),fe=s.control.layers(Le,Oe);p(S,()=>{a.value!==void 0&&(S.value?(a.value.addControl(me),a.value.addControl(fe)):(a.value.removeControl(me),a.value.removeControl(fe)))}),p(ve,()=>{S.value=ve.value}),nt(async()=>{a.value=s.map(E.value,{layers:[W,Z,F,H],attributionControl:!1}).setView(w.value,r.value),a.value.removeControl(a.value.zoomControl),a.value.on("moveend",()=>{if(a.value===void 0)return;let{lat:e,lng:t}=a.value.getCenter();e&&t&&(w.value=[e,t])}),a.value.on("zoomend",()=>{var e;a.value!==void 0&&(r.value=((e=a.value)==null?void 0:e.getZoom())??w.value)}),a.value.on("contextmenu",e=>{var t,n;((t=e==null?void 0:e.latlng)==null?void 0:t.lat)!=null&&((n=e==null?void 0:e.latlng)==null?void 0:n.lng)!=null&&(I.value=[e.latlng.lat,e.latlng.lng])}),b.enableAutoUpdate(),window.addEventListener("keydown",ye),x.value?b.goToTarget(h.VEHICLE):b.goToTarget(h.HOME),!o.isVehicleOnline&&i.vehicleMission.length&&se(i.vehicleMission),m.value=!0,await ee()});const De={open:e=>{e.preventDefault(),a.value&&(G.value.openAt(e),A.value=!0)},close:()=>{ie()}},He=()=>{var e;(e=a.value)==null||e.eachLayer(t=>{(t instanceof s.Marker||t instanceof s.Polyline&&t.options.color==="#358AC3")&&a.value.removeLayer(t)}),k.value=[]},ee=async()=>{m.value&&(He(),o.isVehicleOnline?await xe():i.vehicleMission.length&&se(i.vehicleMission))};p(()=>o.isVehicleOnline,()=>{ee()}),p(()=>i.vehicleMissionRevision,()=>{ee()}),it(()=>{b.disableAutoUpdate(),window.removeEventListener("keydown",ye)}),p(w,(e,t)=>{var n;e.toString()!==t.toString()&&((n=a.value)==null||n.panTo(e))}),p(a,(e,t)=>{a.value!==void 0&&(e==null?void 0:e.options)===void 0&&(a.value=t)}),p(r,(e,t)=>{var n;e!==t&&((n=a.value)==null||n.setZoom(r.value))}),p(M.widget,()=>{var e;(e=a.value)==null||e.invalidateSize()});const _=d(void 0),b=new st(e=>_.value=e,e=>w.value=e);b.setTrackableTarget(h.VEHICLE,()=>x.value),b.setTrackableTarget(h.HOME,()=>v.value);const x=C(()=>o.coordinates.latitude?[o.coordinates.latitude,o.coordinates.longitude]:void 0),te=C(()=>{var e;return o.attitude.yaw?lt((e=o.attitude)==null?void 0:e.yaw):0}),pe=C(()=>{const e=o.lastHeartbeat;return e?`${Ht(e??0,{includeSeconds:!0})} ago`:"never"}),{history:_e}=rt(x);(we=navigator==null?void 0:navigator.geolocation)==null||we.watchPosition(e=>{v.value||(v.value=[e.coords.latitude,e.coords.longitude])},e=>console.error(`Failed to get position: (${e.code}) ${e.message}`),{enableHighAccuracy:!1,timeout:5e3,maximumAge:0});let ge=!0;p([v,a],async()=>{v.value===w.value||!a.value||!ge||(b.goToTarget(h.HOME),ge=!1)});const L=d();p(o.coordinates,()=>{if(!(!a.value||!x.value)){if(L.value===void 0){let e=At;o.vehicleType===Ve.MAV_TYPE_SURFACE_BOAT?e=_t:o.vehicleType===Ve.MAV_TYPE_SUBMARINE&&(e=Nt);const t=s.divIcon({className:"vehicle-marker",html:`<img src="${e}" style="width: 64px; height: 64px;">`,iconSize:[64,64],iconAnchor:[32,32]});L.value=s.marker(x.value,{icon:t});const n=s.tooltip({content:"No data available",className:"waypoint-tooltip",offset:[40,0]});L.value.bindTooltip(n),a.value.addLayer(L.value)}L.value.setLatLng(x.value)}}),p(x,(e,t)=>{_.value===h.VEHICLE||t!==void 0||b.follow(h.VEHICLE)}),p([x,te,pe,()=>o.isArmed],()=>{var t,n,c,f,g;if(L.value===void 0)return;(f=L.value.getTooltip())==null||f.setContent(`
    <p>Coordinates: ${(t=x.value)==null?void 0:t[0].toFixed(6)}, ${(n=x.value)==null?void 0:n[1].toFixed(6)}</p>
    <p>Velocity: ${((c=o.velocity.ground)==null?void 0:c.toFixed(2))??"N/A"} m/s</p>
    <p>Heading: ${te.value.toFixed(2)}°</p>
    <p>${o.isArmed?"Armed":"Disarmed"}</p>
    <p>Last seen: ${pe.value}</p>
  `);const e=(g=L.value.getElement())==null?void 0:g.querySelector("img");e&&(e.style.transform=`rotate(${te.value}deg)`)});const N=d();p(v,()=>{if(a.value===void 0)return;const e=v.value;if(e!==void 0)if(N.value)N.value.setLatLng(e);else{N.value=s.marker(e,{icon:s.divIcon({className:"marker-icon",iconSize:[24,24],iconAnchor:[12,12]}),draggable:!0});const t=s.tooltip({content:'<i class="mdi mdi-home-map-marker text-[18px]"></i>',permanent:!0,direction:"center",className:"waypoint-tooltip",opacity:1});N.value.bindTooltip(t),N.value.on("dragend",n=>{const f=n.target.getLatLng();le([f.lat,f.lng])}),a.value.addLayer(N.value)}});const ae=d();p(k,e=>{a.value&&(ae.value||(ae.value=s.polyline([],{color:"#358AC3"}).addTo(a.value)),ae.value.setLatLngs(e.map(t=>t.coordinates)),e.forEach((t,n)=>{var g;const c=s.marker(t.coordinates);c.setIcon(s.divIcon({className:"marker-icon",iconSize:[16,16],iconAnchor:[8,8]}));const f=s.tooltip({content:n.toString(),permanent:!0,direction:"center",className:"waypoint-tooltip",opacity:1});c.bindTooltip(f),(g=a.value)==null||g.addLayer(c)}))},{deep:!0});const oe=d();p(_e,e=>{if(a.value===void 0||e===void 0)return;oe.value===void 0&&(oe.value=s.polyline([],{color:"#ffff00"}).addTo(a.value));const t=e.filter(n=>n.snapshot!==void 0).map(n=>n.snapshot);oe.value.setLatLngs(t)});const A=d(!1),I=d(null),he=d(),Ne=ct([{item:"Set home waypoint",action:()=>ne("set-home-waypoint"),icon:"mdi-home-map-marker"},{item:"GoTo",action:()=>ne("goto"),icon:"mdi-send-variant"},{item:"Set default map position",action:()=>ne("set-default-map-position"),icon:"mdi-map-check"}]),T=d();let Y=!1;const Ae=async()=>{var e;if(!(!a.value||!I.value))try{await i.setDefaultMapPosition(I.value,r.value),R({message:"Default map position set",variant:"success"});const t=s.marker(I.value,{icon:s.divIcon({className:"marker-icon",iconSize:[24,24],iconAnchor:[12,12]})}).addTo(a.value),n=s.tooltip({content:'<i class="mdi mdi-crosshairs-gps text-[18px]"></i>',permanent:!0,direction:"center",className:"waypoint-tooltip",opacity:1});t.bindTooltip(n).openTooltip();const c=t.getElement(),f=(e=t.getTooltip())==null?void 0:e.getElement();[c,f].forEach(g=>{g&&(g.style.transition="opacity 1s",g.style.opacity="1")}),setTimeout(()=>{[c,f].forEach(g=>{g&&(g.style.opacity="0")}),setTimeout(()=>{var g;(g=a.value)==null||g.removeLayer(t)},1e3)},1500)}catch(t){console.error(t),R({message:"Failed to set default map position",variant:"error"})}},ze=()=>{if(!I.value||!a.value)return;T.value&&(a.value.removeLayer(T.value),T.value=void 0),T.value=s.marker(I.value,{icon:s.divIcon({className:"marker-icon",iconSize:[24,24],iconAnchor:[12,12]})}).addTo(a.value);const e=s.tooltip({content:'<i class="mdi mdi-map-marker text-[18px]"></i>',permanent:!0,direction:"center",className:"waypoint-tooltip",opacity:1});T.value.bindTooltip(e),Y=!1,Promise.resolve(Ct(async()=>{Y=!0;const[t,n]=I.value,c=o.coordinates.altitude??0;try{await o.goTo(0,0,0,0,t,n,c)}catch(f){R({message:`${f}`,variant:"error"})}},{command:"GoTo"},Vt(Et.GOTO))).catch(()=>{T.value&&a.value&&(a.value.removeLayer(T.value),T.value=void 0)})},ne=e=>{switch(e){case"goto":{ze();break}case"set-default-map-position":Ae();break;case"set-home-waypoint":I.value&&le(I.value);break;default:console.warn("Unknown menu option selected:",e)}A.value=!1};p(ut,(e,t)=>{t&&!e&&(!Y&&T.value&&a.value&&(a.value.removeLayer(T.value),T.value=void 0),Y=!1)});const ie=()=>{A.value=!1,a.value!==void 0&&he.value!==void 0&&a.value.removeLayer(he.value)},ye=e=>{e.key==="Escape"&&ie()},se=e=>{e.forEach((t,n)=>{n===0?(v.value=t.coordinates,le(t.coordinates)):k.value.push(t)})},q=d(!1),be=d(0),xe=async()=>{q.value=!0;const e=async t=>{be.value=t};try{const t=await o.fetchMission(e);se(t),R({variant:"success",message:"Mission download succeeded!",duration:3e3})}catch(t){B({variant:"error",title:"Mission download failed",message:t,timer:5e3})}finally{q.value=!1}},le=async e=>{const t=[e[0],e[1]];v.value=t,await o.setHomeWaypoint(t,0),A.value&&(A.value=!1)},Pe=async()=>{try{await o.startMission()}catch{R({message:"Failed to start mission.",variant:"error"})}},U=dt(),$e=C(()=>`${Math.max(-U.widgetClearanceForVisibleArea(l.value).bottom,0)}px`),Me=C(()=>`${Math.max(-U.widgetClearanceForVisibleArea(l.value).top,0)}px`),Be=C(()=>o.isVehicleOnline?"Download the mission that is stored in the vehicle.":"Cannot download mission (vehicle offline)."),Fe=C(()=>o.isVehicleOnline?"Execute the mission that is stored in the vehicle.":"Cannot execute mission (vehicle offline)."),Ue=C(()=>v.value===void 0?"Cannot center map on home (home position undefined).":_.value===h.HOME?"Tracking home position. Click to stop tracking.":"Click once to center on home or twice to track it."),Re=C(()=>o.isVehicleOnline?x.value===void 0?"Cannot center map on vehicle (vehicle position undefined).":_.value===h.VEHICLE?"Tracking vehicle position. Click to stop tracking.":"Click once to center on vehicle or twice to track it.":"Cannot center map on vehicle (vehicle offline).");return(e,t)=>{const n=vt("contextmenu");return O(),re(kt,null,[mt((O(),re("div",{ref_key:"mapBase",ref:de,class:ft(["page-base",u(U).editingMode?"pointer-events-none":"pointer-events-auto"])},[pt("div",{id:E.value,ref_key:"map",ref:a,class:"map"},[V(Q,{location:"top",text:Ue.value},{activator:D(({props:c})=>[S.value?(O(),X(j,J({key:0},c,{class:["absolute right-[166px] m-3 bottom-button bg-slate-50 text-[14px]",v.value?"":"active-events-on-disabled"],color:_.value==u(h).HOME?"red":"",elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-home-search",size:"x-small",disabled:!v.value,onClick:t[0]||(t[0]=z(f=>u(b).goToTarget(u(h).HOME,!0),["stop"])),onDblclick:t[1]||(t[1]=z(f=>u(b).follow(u(h).HOME),["stop"]))}),null,16,["class","color","disabled"])):P("",!0)]),_:1},8,["text"]),V(Q,{location:"top",text:Re.value},{activator:D(({props:c})=>[S.value?(O(),X(j,J({key:0},c,{class:["absolute m-3 bottom-button right-[124px] bg-slate-50 text-[14px]",x.value?"":"active-events-on-disabled"],color:_.value==u(h).VEHICLE?"red":"",elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-airplane-marker",size:"x-small",disabled:!x.value,onClick:t[2]||(t[2]=z(f=>u(b).goToTarget(u(h).VEHICLE,!0),["stop"])),onDblclick:t[3]||(t[3]=z(f=>u(b).follow(u(h).VEHICLE),["stop"]))}),null,16,["class","color","disabled"])):P("",!0)]),_:1},8,["text"]),V(Q,{location:"top",text:Be.value},{activator:D(({props:c})=>[S.value?(O(),X(j,J({key:0},c,{class:["absolute m-3 bottom-button right-[82px] bg-slate-50 text-[14px]",u(o).isVehicleOnline?"":"active-events-on-disabled"],disabled:!u(o).isVehicleOnline,elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-download",size:"x-small",onClick:z(xe,["stop"])}),null,16,["class","disabled"])):P("",!0)]),_:1},8,["text"]),V(Q,{location:"top",text:Fe.value},{activator:D(({props:c})=>[S.value?(O(),X(j,J({key:0},c,{class:["absolute mb-3 ml-1 bottom-button right-[52px] bg-slate-50 text-[14px]",u(o).isVehicleOnline?"":"active-events-on-disabled"],disabled:!u(o).isVehicleOnline,elevation:"2",style:{"z-index":"1002","border-radius":"0px"},icon:"mdi-play",size:"x-small",onClick:z(Pe,["stop"])}),null,16,["class","disabled"])):P("",!0)]),_:1},8,["text"])],8,zt)],2)),[[n,De]]),V(gt,{ref_key:"contextMenuRef",ref:G,visible:A.value,width:"260px","menu-items":Ne,onClose:ie},null,8,["visible","menu-items"]),V(wt,{modelValue:u(U).widgetManagerVars(u(l).hash).configMenuOpen,"onUpdate:modelValue":t[5]||(t[5]=c=>u(U).widgetManagerVars(u(l).hash).configMenuOpen=c),width:"auto"},{default:D(()=>[V(ht,{class:"pa-2",style:ce(u($).globalGlassMenuStyles)},{default:D(()=>[V(yt,{class:"text-center"},{default:D(()=>t[6]||(t[6]=[bt("Map widget settings")])),_:1}),V(xt,null,{default:D(()=>[V(Mt,{modelValue:u(l).options.showVehiclePath,"onUpdate:modelValue":t[4]||(t[4]=c=>u(l).options.showVehiclePath=c),class:"my-1",label:"Show vehicle path",color:u(l).options.showVehiclePath?"white":void 0,"hide-details":""},null,8,["modelValue","color"])]),_:1})]),_:1},8,["style"])]),_:1},8,["modelValue"]),q.value?(O(),X(Tt,{key:0,"model-value":be.value,height:"10",absolute:"",bottom:"",color:"white",style:ce(`top: ${Me.value}`)},null,8,["model-value","style"])):P("",!0),q.value?(O(),re("p",{key:1,style:ce({top:Me.value}),class:"absolute left-[7px] mt-4 flex text-md font-bold text-white z-30 drop-shadow-md"}," Loading mission... ",4)):P("",!0)],64)}}}),Bt=St(Pt,[["__scopeId","data-v-19dea636"]]);export{Bt as default};
